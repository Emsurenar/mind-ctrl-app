<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impuls & Fokus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: {
                            950: 'rgb(var(--c-bg-main) / <alpha-value>)',
                            900: 'rgb(var(--c-bg-card) / <alpha-value>)',
                            800: 'rgb(var(--c-border) / <alpha-value>)',
                            700: 'rgb(var(--c-input) / <alpha-value>)',
                            400: 'rgb(var(--c-text-muted) / <alpha-value>)',
                        },
                        white: 'rgb(var(--c-text-main) / <alpha-value>)',
                        blue: { 400: 'rgb(var(--c-blue) / <alpha-value>)', 600: 'rgb(var(--c-blue-600) / <alpha-value>)', 950: 'rgb(var(--c-blue-dark) / <alpha-value>)' },
                        green: { 400: 'rgb(var(--c-green) / <alpha-value>)' },
                        red: { 400: 'rgb(var(--c-red) / <alpha-value>)' },
                        sky: { 950: 'rgb(var(--c-sky-dark) / <alpha-value>)' },
                        indigo: { 950: 'rgb(var(--c-indigo-dark) / <alpha-value>)' },
                    }
                }
            }
        }
    </script>
    
    <style>
        :root {
            /* Dark Mode (Default) */
            --c-bg-main: 2 6 23;      /* slate-950 */
            --c-bg-card: 15 23 42;    /* slate-900 */
            --c-border: 30 41 59;     /* slate-800 */
            --c-input: 51 65 85;      /* slate-700 */
            --c-text-muted: 148 163 184; /* slate-400 */
            --c-text-main: 255 255 255;  /* white */
            --c-blue: 96 165 250;     /* blue-400 */
            --c-blue-600: 37 99 235;  /* blue-600 */
            --c-green: 74 222 128;    /* green-400 */
            --c-red: 248 113 113;     /* red-400 */
            
            /* Gradients bases */
            --c-sky-dark: 8 47 73;    /* sky-950 */
            --c-blue-dark: 23 37 84;  /* blue-950 */
            --c-indigo-dark: 30 27 75; /* indigo-950 */
        }

        .light-mode {
            /* Light Mode Overrides - Piggare & Estetiskt */
            --c-bg-main: 240 249 255; /* sky-50 */
            --c-bg-card: 255 255 255; /* white */
            --c-border: 226 232 240;  /* slate-200 */
            --c-input: 241 245 249;   /* slate-100 */
            --c-text-muted: 100 116 139; /* slate-500 */
            --c-text-main: 15 23 42;  /* slate-900 */
            
            --c-blue: 14 165 233;     /* sky-500 */
            --c-blue-600: 2 132 199;  /* sky-600 */
            --c-green: 16 185 129;    /* emerald-500 */
            --c-red: 244 63 94;       /* rose-500 */

            /* Gradients bases (Light - Mer färgstarka) */
            --c-sky-dark: 56 189 248; /* sky-400 */
            --c-blue-dark: 96 165 250; /* blue-400 */
            --c-indigo-dark: 129 140 248; /* indigo-400 */
        }

        body { background-color: rgb(var(--c-bg-main)); color: rgb(var(--c-blue)); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; transition: background-color 0.3s, color 0.3s; }
        .input-field { @apply w-full bg-slate-700 border border-slate-600 rounded-lg py-4 px-8 mb-6 text-lg text-white focus:outline-none focus:border-blue-500 transition-all; }
        .btn-primary { @apply w-full bg-blue-600 hover:bg-blue-700 text-slate-50 font-bold py-3 px-4 rounded-xl transition-colors active:scale-95; }
        .btn-secondary { @apply w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded transition-colors active:scale-95; }
        .card { @apply bg-slate-900 border border-slate-800 rounded-lg p-4 shadow-lg mb-4; }
        
        @keyframes pulse-red {
            0%, 100% { background-color: #7f1d1d; }
            50% { background-color: #991b1b; }
        }
        .animate-alarm { animation: pulse-red 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in { animation: fade-in 0.2s ease-out; }

        @keyframes scale-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-scale-in { animation: scale-in 0.2s ease-out; }

        @keyframes subtle-glow {
            0%, 100% {
                text-shadow: 0 0 4px rgba(var(--c-blue), 0.2), 0 0 10px rgba(var(--c-blue), 0.1);
            }
            50% {
                text-shadow: 0 0 8px rgba(var(--c-blue), 0.5), 0 0 20px rgba(var(--c-blue), 0.2);
            }
        }
        .animate-logo-glow { animation: subtle-glow 4s ease-in-out infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- SUPABASE CONFIGURATION ---
        // Byt ut dessa mot dina egna värden från Supabase Dashboard -> Project Settings -> API
        const supabaseUrl = 'https://ifrjtdbfhhornllbprlp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlmcmp0ZGJmaGhvcm5sbGJwcmxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMzg2NzEsImV4cCI6MjA4MTkxNDY3MX0.-j0aBpoaOoGTcqGk27EWoE2pNz4uPWdHvhoKTNPscvk';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // --- INLINE ICONS ---
        const IconTimer = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
        const IconZap = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>;
        const IconList = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>;
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>;
        const IconBell = () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
        const IconPlay = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>;
        const IconGrid = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>;
        const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const IconHome = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>;
        const IconCalendar = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>;
        const IconChevronLeft = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>;
        const IconChevronRight = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>;
        const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>;
        const IconSun = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>;
        const IconMoon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>;
        const IconLogOut = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>;
        const IconMail = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>;
        const IconLock = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>;

        // --- AUDIO HELPER (Syntetiskt ljud, inga filer behövs) ---
        const playBeep = () => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'square';
                osc.frequency.setValueAtTime(440, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
                osc.start();
                osc.stop(ctx.currentTime + 0.5);
            } catch (e) { console.error("Audio error", e); }
        };

        const sendNotification = (title, options) => {
            if (!('Notification' in window)) {
                console.error("This browser does not support desktop notification.");
                return;
            }
            if (Notification.permission === "granted") {
                new Notification(title, options);
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification(title, options);
                    }
                });
            }
        };

        const NavButton = ({ active, icon, label, onClick }) => (
            <button 
                onClick={onClick}
                className={`flex flex-col items-center justify-center p-2 flex-1 transition-colors ${active ? 'text-blue-400' : 'text-slate-500 hover:text-slate-300'}`}
            >
                {icon}
                <span className="text-xs mt-1">{label}</span>
            </button>
        );

        // 1. Aktivitetstimer (Uppdaterad med Nedräkning & Alarm)
        const ActivityTimer = ({ data, setData, saveLog, deleteTodoById }) => {
            const [state, setState] = useState('setup'); // setup, running, alarm, review
            const [remaining, setRemaining] = useState(0);
            const [targetTime, setTargetTime] = useState(null);
            const [initialDuration, setInitialDuration] = useState(0); // Sparar totaltiden för loggen
            const [review, setReview] = useState({ success: true, satisfaction: 50 });
            const [sessionBehaviors, setSessionBehaviors] = useState([]);
            
            // Timer logic
            useEffect(() => {
                let interval;
                if (state === 'running' && targetTime) {
                    interval = setInterval(() => {
                        const newRemaining = Math.max(0, Math.round((targetTime - Date.now()) / 1000));
                        setRemaining(newRemaining);

                        if (newRemaining <= 0) {
                            clearInterval(interval);
                            setState('alarm');
                        }
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [state, targetTime]);

            // Alarm Sound Loop
            useEffect(() => {
                let soundInterval;
                if (state === 'alarm') {
                    sendNotification('Tiden är ute!', { body: `Målet var: ${data.goal}` });
                    playBeep(); // Spela direkt
                    soundInterval = setInterval(playBeep, 1500); // Repetera var 1.5s
                }
                return () => clearInterval(soundInterval);
            }, [state, data.goal]);

            const startSession = () => {
                const totalSeconds = parseInt(data.durationMinutes) * 60;
                setRemaining(totalSeconds);
                setInitialDuration(totalSeconds);
                setTargetTime(Date.now() + totalSeconds * 1000);
                setSessionBehaviors([]);
                setState('running');

                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            };

            const stopAlarm = () => {
                setState('review');
            };

            const cancelSession = () => {
                if(confirm("Vill du avbryta passet?")) {
                    setSessionBehaviors([]);
                    setState('setup');
                }
            }

            const saveSession = async () => {
                const sessionLog = {
                    type: 'activity',
                    data: {
                        durationSeconds: initialDuration,
                        ...data,
                        ...review,
                        behaviors: sessionBehaviors
                    }
                };
                await saveLog(sessionLog);

                if (review.success && data.originTodoId) {
                    await deleteTodoById(data.originTodoId);
                }

                setState('setup');
                setData({ goal: '', challenges: '', motivation: 50, durationMinutes: 25 });
                setSessionBehaviors([]);
                alert("Pass sparat!");
            };

            const formatTime = (s) => {
                const min = Math.floor(s / 60);
                const sec = s % 60;
                return `${min}:${sec < 10 ? '0' : ''}${sec}`;
            };

            // --- Vyer ---

            const isInvalid = !data.goal;

            if (state === 'setup') return (
                <div className="p-4 h-full flex flex-col">
                    <div className="mb-6">
                        <h2 className="text-3xl font-bold text-white">Fokus</h2>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto space-y-4 pb-4">
                        {/* Duration */}
                        <div className="bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
                            <div className="flex justify-between items-center mb-3">
                                <label className="text-slate-400 text-xs uppercase font-bold tracking-wider">Tidslängd</label>
                                <span className="text-white font-bold">{data.durationMinutes} min</span>
                            </div>
                            <div className="grid grid-cols-4 gap-2">
                                {[15, 25, 45, 60].map(m => (
                                    <button key={m} onClick={() => setData({...data, durationMinutes: m})} className={`py-2 rounded-lg text-sm font-bold transition-all ${data.durationMinutes == m ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50 scale-105' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>{m}</button>
                                ))}
                            </div>
                            <input type="range" min="5" max="120" step="5" value={data.durationMinutes} onChange={e => setData({...data, durationMinutes: e.target.value})} className="w-full mt-4 accent-blue-500 h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
                        </div>

                        {/* Goal */}
                        <div className="bg-gradient-to-br from-blue-500/10 to-blue-600/5 border border-blue-500/20 p-4 rounded-2xl relative overflow-hidden group focus-within:border-blue-500/50 transition-colors">
                            <div className="absolute top-0 right-0 p-2 opacity-10 pointer-events-none"><IconTimer /></div>
                            <label className="block text-blue-400 text-xs uppercase font-bold tracking-wider mb-2">Vad är målet?</label>
                            <textarea rows="2" className="w-full bg-transparent text-xl font-bold text-white placeholder-blue-500/30 focus:outline-none resize-none" placeholder="Skriv ditt mål här..." value={data.goal} onChange={e => setData({...data, goal: e.target.value})} />
                        </div>

                        {/* Challenges */}
                        <div className="bg-slate-900/50 border border-slate-800 rounded-2xl p-4 focus-within:border-slate-600 transition-colors">
                            <label className="block text-slate-400 text-xs uppercase font-bold tracking-wider mb-2">Utmaningar?</label>
                            <input className="w-full bg-transparent text-white placeholder-slate-600 focus:outline-none" placeholder="T.ex. distraktioner..." value={data.challenges} onChange={e => setData({...data, challenges: e.target.value})} />
                        </div>

                        {/* Motivation */}
                        <div className="bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
                            <div className="flex items-center justify-between mb-2">
                                <label className="text-slate-400 text-xs uppercase font-bold tracking-wider">Motivation</label>
                                <span className={`font-bold ${data.motivation > 80 ? 'text-green-400' : data.motivation > 50 ? 'text-blue-400' : 'text-slate-400'}`}>{data.motivation}%</span>
                            </div>
                            <input type="range" min="0" max="100" value={data.motivation} onChange={e => setData({...data, motivation: parseInt(e.target.value)})} className="w-full accent-blue-500 h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
                        </div>
                    </div>

                    <div className="mt-2">
                        <button disabled={isInvalid} className={`w-full block font-bold text-xl py-4 rounded-2xl transition-all duration-500 shadow-xl ${isInvalid ? 'bg-slate-800 text-slate-600 cursor-not-allowed' : 'bg-gradient-to-r from-orange-500 to-orange-600 text-white hover:scale-[1.02] active:scale-[0.98] shadow-orange-900/20'}`} onClick={startSession}>Starta timer</button>
                    </div>
                </div>
            );

            if (state === 'running') {
                const progress = ((initialDuration - remaining) / initialDuration) * 100;
                return (
                    <div className="flex flex-col h-full p-4 relative pt-6">
                        {/* Progress bar background */}
                        <div className="absolute top-0 left-0 h-2 bg-slate-800 w-full">
                            <div className="h-full bg-green-500 transition-all duration-1000" style={{width: `${progress}%`}}></div>
                        </div>

                        <div className="flex-1 flex flex-col items-center justify-center">
                            <div className="text-7xl font-mono font-bold text-green-400 mb-8 tracking-tighter">{formatTime(remaining)}</div>
                            <div className="text-center mb-8 space-y-2 max-w-xs">
                                <p className={`text-white font-bold ${data.challenges ? 'text-lg' : 'text-2xl'}`}>{data.goal}</p>
                                {data.challenges && <p className="text-slate-400 text-sm">Utmaning: {data.challenges}</p>}
                            </div>
                        </div>
                        
                        <button className="text-slate-500 hover:text-white underline text-sm mt-4 text-center" onClick={cancelSession}>Avbryt pass</button>
                    </div>
                );
            }

            if (state === 'alarm') return (
                <div className="flex flex-col items-center justify-center h-full p-4 animate-alarm bg-red-900">
                    <IconBell />
                    <h1 className="text-4xl font-bold text-white mt-4 mb-8">Tiden är ute!</h1>
                    <p className="text-white/80 mb-8 text-center">{data.goal}</p>
                    <button className="w-full bg-transparent text-white text-xl font-bold py-6 hover:text-slate-200 transition-colors active:scale-95" onClick={stopAlarm}>
                        Stäng av och utvärdera
                    </button>
                </div>
            );

            if (state === 'review') return (
                <div className="p-4 space-y-4 text-center">
                    <h2 className="text-xl font-bold">Bra jobbat!</h2>
                    <p className="text-slate-400">Du fokuserade i {data.durationMinutes} minuter.</p>
                    <div className="space-y-2">
                        <p>Uppnådde du målet?</p>
                        <div className="flex gap-2">
                            <button onClick={() => setReview({...review, success: true})} className={`flex-1 p-3 rounded border ${review.success ? 'bg-green-900/30 border-green-500 text-green-400' : 'border-slate-700'}`}>Ja</button>
                            <button onClick={() => setReview({...review, success: false})} className={`flex-1 p-3 rounded border ${!review.success ? 'bg-red-900/30 border-red-500 text-red-400' : 'border-slate-700'}`}>Nej</button>
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm text-slate-400 mb-1">Nöjdhet (0-100)</label>
                        <div className="flex items-center gap-4">
                            <input type="range" min="0" max="100" value={review.satisfaction} onChange={e => setReview({...review, satisfaction: parseInt(e.target.value)})} className="w-full accent-blue-500" />
                            <span className="font-bold w-8">{review.satisfaction}</span>
                        </div>
                    </div>
                    <button className="btn-primary" onClick={saveSession}>Spara till Logg</button>
                    <button className="text-slate-400 hover:text-white text-sm mt-4 underline block w-full" onClick={() => {
                        setState('setup');
                        setData({ goal: '', challenges: '', motivation: 50, durationMinutes: 25 });
                        setSessionBehaviors([]);
                    }}>Spara inte</button>
                </div>
            );
        };

        // 2. Impulskontroll (Oförändrad logik, bara inlistad för kompletthet)
        const ImpulseControl = ({ logs, impulses, addImpulse, completeImpulse }) => {
            const [newImpulse, setNewImpulse] = useState({ desc: '', estTime: '' });
            const [now, setNow] = useState(Date.now());
            const [stats, setStats] = useState({ done: 0, forgotten: 0, percentage: 0 });
            const [isAdding, setIsAdding] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [resetTrigger, setResetTrigger] = useState(0);
            const longPressTimer = useRef(null);

            useEffect(() => {
                const interval = setInterval(() => setNow(Date.now()), 1000);
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                // This effect now depends on the logs prop from App
                const resetTime = parseInt(localStorage.getItem('impulseResetTime') || '0');
                const validLogs = logs.filter(l => new Date(l.created_at).getTime() > resetTime);
                
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;
                const recent = validLogs.filter(l => (now - new Date(l.created_at).getTime()) < oneDay);
                
                const allImpulses = validLogs.filter(l => l.type === 'impulse_done' || l.type === 'impulse_forgotten');
                const percentage = allImpulses.length > 0 ? Math.round((allImpulses.filter(l => l.type === 'impulse_done').length / allImpulses.length) * 100) : 0;

                setStats({
                    done: recent.filter(l => l.type === 'impulse_done').length,
                    forgotten: recent.filter(l => l.type === 'impulse_forgotten').length,
                    percentage
                });
            }, [logs, resetTrigger]);

            const formatCountdown = (unlockTime) => {
                const diff = unlockTime - now;
                if (diff <= 0) return "REDO";
                const h = Math.floor(diff / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                return `${h}h ${m}m ${s}s`;
            };

            const handleLongPressStart = () => {
                longPressTimer.current = setTimeout(() => {
                    if(confirm("Vill du nollställa statistiken?")) {
                        localStorage.setItem('impulseResetTime', Date.now().toString());
                        setResetTrigger(prev => prev + 1);
                    }
                }, 800);
            };

            const handleLongPressEnd = () => {
                if (longPressTimer.current) clearTimeout(longPressTimer.current);
            };

            const isInvalid = !newImpulse.desc || !newImpulse.estTime;

            return (
                <div className="p-4 h-full flex flex-col relative">
                    <div className="mb-6">
                        <h2 className="text-3xl font-bold text-white">Impulser</h2>
                    </div>

                    <div 
                        className="mb-6 select-none active:scale-[0.99] transition-transform"
                        onMouseDown={handleLongPressStart}
                        onMouseUp={handleLongPressEnd}
                        onMouseLeave={handleLongPressEnd}
                        onTouchStart={handleLongPressStart}
                        onTouchEnd={handleLongPressEnd}
                    >
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div className="bg-slate-900/50 border border-slate-800 p-3 rounded-xl">
                                <div className="text-green-400 text-xs font-bold uppercase tracking-wider mb-1">Gjorda (24h)</div>
                                <div className="text-2xl font-bold text-white">{stats.done}</div>
                            </div>
                            <div className="bg-slate-900/50 border border-slate-800 p-3 rounded-xl">
                                <div className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Glömda (24h)</div>
                                <div className="text-2xl font-bold text-white">{stats.forgotten}</div>
                            </div>
                        </div>
                        <div 
                            onClick={() => setShowHistory(true)}
                            className="bg-slate-900/50 border border-slate-800 p-3 rounded-xl flex justify-between items-center cursor-pointer hover:bg-slate-800 transition-colors active:scale-95"
                        >
                            <div>
                                <div className="text-blue-400 text-xs font-bold uppercase tracking-wider mb-1">Fullföljda</div>
                                <div className="text-xs text-slate-500">Andel av alla impulser</div>
                            </div>
                            <div className="text-2xl font-bold text-white">{stats.percentage}%</div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto space-y-3 pb-20">
                        {impulses.length === 0 && <p className="text-center text-slate-500 mt-10 text-sm">Inga aktiva impulser.</p>}
                        {impulses.map(imp => {
                            const isReady = new Date(imp.unlock_time) <= now;
                            return (
                                <div key={imp.id} className={`bg-slate-900/50 border rounded-2xl p-4 transition-all ${isReady ? 'border-green-500/50 shadow-[0_0_15px_rgba(34,197,94,0.1)]' : 'border-slate-800'}`}>
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h3 className="font-bold text-lg text-white">{imp.desc}</h3>
                                            <p className="text-slate-400 text-xs mt-1">Väntetid: {imp.est_time} min</p>
                                        </div>
                                        {isReady ? (
                                            <div className="flex flex-col gap-2">
                                                <button onClick={() => completeImpulse(imp.id, 'done')} className="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded-lg text-sm font-bold transition-colors">Gör</button>
                                                <button onClick={() => completeImpulse(imp.id, 'forgotten')} className="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded-lg text-sm font-bold transition-colors">Glöm</button>
                                            </div>
                                        ) : <span className="font-mono text-yellow-500 font-bold text-sm bg-yellow-500/10 px-2 py-1 rounded">{formatCountdown(new Date(imp.unlock_time))}</span>}
                                    </div>
                                </div>
                            )
                        })}
                    </div>

                    <button 
                        onClick={() => setIsAdding(true)}
                        className="absolute bottom-6 right-6 w-14 h-14 bg-blue-600 hover:bg-blue-500 rounded-full flex items-center justify-center shadow-lg text-white transition-transform active:scale-90 z-10"
                    >
                        <IconPlus />
                    </button>

                    {isAdding && (
                        <div className="fixed inset-0 bg-slate-950/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in" onClick={() => setIsAdding(false)}>
                            <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl animate-scale-in text-center" onClick={e => e.stopPropagation()}>
                                <h3 className="text-2xl font-bold mb-6 text-white">Registrera Impuls</h3>
                                <input className="input-field text-center !py-3 !mb-3" placeholder="Vad vill du göra?" autoFocus value={newImpulse.desc} onChange={e => setNewImpulse({...newImpulse, desc: e.target.value})} />
                                <input type="number" className="input-field text-center !py-3 !mb-3" placeholder="Tid (min)?" value={newImpulse.estTime} onChange={e => setNewImpulse({...newImpulse, estTime: e.target.value})} />
                                <div className="flex gap-2 mt-4">
                                    <button onClick={() => setIsAdding(false)} className="btn-secondary">Avbryt</button>
                                    <button disabled={isInvalid} className={`w-full font-bold text-lg py-3 rounded-xl transition-colors ${isInvalid ? 'bg-slate-800 text-slate-600 cursor-not-allowed' : 'bg-gradient-to-r from-orange-500 to-orange-600 text-white'}`} onClick={() => {
                                        addImpulse(newImpulse).then(() => {
                                            setNewImpulse({ desc: '', estTime: '' });
                                            setIsAdding(false);
                                        });
                                    }}>
                                        Lås in
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showHistory && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in" onClick={() => setShowHistory(false)}>
                            <div className="bg-slate-900 border border-slate-800 rounded-2xl max-w-sm w-full shadow-2xl animate-scale-in overflow-hidden flex flex-col max-h-[80vh]" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b border-slate-800 bg-slate-900">
                                    <h3 className="font-bold text-white text-lg">Impulshistorik</h3>
                                </div>
                                <div className="p-4 overflow-y-auto space-y-6">
                                    {(() => {
                                        const resetTime = parseInt(localStorage.getItem('impulseResetTime') || '0');
                                        const validLogs = logs.filter(l => new Date(l.created_at).getTime() > resetTime);
                                        const done = validLogs.filter(l => l.type === 'impulse_done').reverse();
                                        const forgotten = validLogs.filter(l => l.type === 'impulse_forgotten').reverse();

                                        return (
                                            <>
                                                <div>
                                                    <div className="flex justify-between items-center mb-3">
                                                        <h4 className="text-green-400 text-xs font-bold uppercase tracking-wider">Fullföljda</h4>
                                                        <span className="text-xs text-slate-500 font-mono">{done.length} st</span>
                                                    </div>
                                                    <div className="space-y-2">
                                                        {done.length === 0 && <p className="text-slate-500 text-sm italic text-center py-2">Inga fullföljda än.</p>}
                                                        {done.map((l, i) => (
                                                            <div key={i} className="bg-slate-800/50 p-3 rounded-lg border border-slate-700/50 flex justify-between items-start gap-2 truncate">
                                                                <div className="truncate">
                                                                    <p className="text-white font-medium text-sm truncate">{l.data.desc || 'Okänd impuls'}</p>
                                                                    <p className="text-slate-500 text-[10px] mt-0.5">{new Date(l.created_at).toLocaleString('sv-SE', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'})}</p>
                                                                </div>
                                                                <div className="text-green-500 scale-75 origin-top-right"><IconCheck /></div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div className="flex justify-between items-center mb-3">
                                                        <h4 className="text-slate-400 text-xs font-bold uppercase tracking-wider">Ej fullföljda</h4>
                                                        <span className="text-xs text-slate-500 font-mono">{forgotten.length} st</span>
                                                    </div>
                                                    <div className="space-y-2">
                                                        {forgotten.length === 0 && <p className="text-slate-500 text-sm italic text-center py-2">Inga glömda än.</p>}
                                                        {forgotten.map((l, i) => (
                                                            <div key={i} className="bg-slate-800/30 p-3 rounded-lg border border-slate-800 flex justify-between items-start gap-2 truncate">
                                                                <div className="truncate">
                                                                    <p className="text-slate-400 font-medium text-sm truncate">{l.data.desc || 'Okänd impuls'}</p>
                                                                    <p className="text-slate-600 text-[10px] mt-0.5">{new Date(l.created_at).toLocaleString('sv-SE', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'})}</p>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </>
                                        );
                                    })()}
                                </div>
                                <div className="p-4 border-t border-slate-800 mt-auto">
                                    <button className="btn-secondary w-full" onClick={() => setShowHistory(false)}>Stäng</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 3. Dashboard (Start/Huvudfönster)
        const Dashboard = ({ onOpenSettings, logs, habits, deleteLog }) => {
            const [selectedLog, setSelectedLog] = useState(null);
            const [timeRange, setTimeRange] = useState('24h');
            const [statsView, setStatsView] = useState(null);
            const [selectedGraphBarIndex, setSelectedGraphBarIndex] = useState(null);
            const [habitStats, setHabitStats] = useState({ doneToday: 0, totalActive: 0, streak: 0, weeklyDone: 0, weeklyTotal: 0 });

            const getGreeting = () => {
                const h = new Date().getHours();
                if (h >= 5 && h < 12) return "God morgon";
                if (h >= 12 && h < 18) return "God eftermiddag";
                return "God kväll";
            };

            const getBackgroundGradient = () => {
                const h = new Date().getHours();
                if (h >= 5 && h < 12) return "bg-gradient-to-b from-sky-950/40 to-slate-950";
                if (h >= 12 && h < 18) return "bg-gradient-to-b from-blue-950/40 to-slate-950";
                return "bg-gradient-to-b from-indigo-950/40 to-slate-950";
            };

            useEffect(() => {
                // Habit Stats Calculation
                const todayStr = new Date().toISOString().split('T')[0];
                const habitLogs = logs.filter(l => l.type === 'habit_done');
                const doneToday = new Set(habitLogs.filter(l => l.created_at.startsWith(todayStr)).map(l => l.data.habitId)).size;
                
                // Weekly stats
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 6);
                oneWeekAgo.setHours(0,0,0,0);
                const weeklyDone = habitLogs.filter(l => new Date(l.created_at) >= oneWeekAgo).length;

                // Streak Calculation (All habits must be done for a day to count)
                let streak = 0;
                if (habits.length > 0) {
                    let d = new Date();
                    d.setHours(0,0,0,0);
                    
                    // Check today and backwards
                    while (true) {
                        const ds = d.toISOString().split('T')[0];
                        // Count unique completed habits for this date
                        const doneCountForDay = new Set(habitLogs.filter(l => l.created_at.startsWith(ds)).map(l => l.data.habitId)).size;
                        
                        if (doneCountForDay >= habits.length) {
                            streak++;
                            d.setDate(d.getDate() - 1);
                        } else {
                            break;
                        }
                    }
                }

                setHabitStats({ doneToday: doneToday, totalActive: habits.length, streak, weeklyDone, weeklyTotal: habits.length * 7 });
            }, [logs, habits]);

            const closeStatsView = () => {
                setStatsView(null);
                setSelectedGraphBarIndex(null);
            };

            // Statistik-beräkning
            const now = new Date();
            const timeWindow = timeRange === '24h' ? 24 * 60 * 60 * 1000 : 7 * 24 * 60 * 60 * 1000;
            const recentActivity = logs.filter(l => l.type === 'activity' && (now - new Date(l.created_at).getTime()) < timeWindow);
            const totalMinutes = Math.round(recentActivity.reduce((acc, curr) => acc + (curr.data.durationSeconds / 60), 0));
            
            const recentTodos = logs.filter(l => l.type === 'todo_done' && (now - new Date(l.created_at).getTime()) < timeWindow);
            const totalTodos = recentTodos.length;
            
            let graphData = [];
            let graphLabels = [];
            let days = []; // För 7d-vyn

            if (timeRange === '24h') {
                graphData = new Array(24).fill(0);
                recentActivity.forEach(l => {
                    const h = new Date(l.created_at).getHours();
                    graphData[h] += (l.data.durationSeconds / 60);
                });
                graphLabels = ['00:00', '12:00', '23:59'];
            } else {
                graphData = new Array(7).fill(0);
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    days.push(d);
                }
                
                recentActivity.forEach(l => {
                    const lDate = new Date(l.created_at).toISOString().split('T')[0];
                    const dayIndex = days.findIndex(d => d.toISOString().split('T')[0] === lDate);
                    if (dayIndex !== -1) {
                        graphData[dayIndex] += (l.data.durationSeconds / 60);
                    }
                });
                
                const options = { weekday: 'short' };
                graphLabels = [days[0].toLocaleDateString('sv-SE', options), days[3].toLocaleDateString('sv-SE', options), days[6].toLocaleDateString('sv-SE', options)];
            }
            
            const maxVal = Math.max(...graphData, 1);

            // Cirkeldiagram-data
            const behaviorCounts = {};
            recentActivity.forEach(l => {
                if (l.data.behaviors) {
                    l.data.behaviors.forEach(b => {
                        behaviorCounts[b.behavior] = (behaviorCounts[b.behavior] || 0) + 1;
                    });
                }
            });
            const totalBehaviors = Object.values(behaviorCounts).reduce((a, b) => a + b, 0);
            let currentAngle = 0;
            const colors = ['#60a5fa', '#34d399', '#f87171', '#fbbf24', '#a78bfa', '#e879f9'];
            const pieSegments = Object.entries(behaviorCounts).sort((a,b) => b[1] - a[1]).map(([name, count], index) => {
                const angle = (count / totalBehaviors) * 360;
                const color = colors[index % colors.length];
                const style = `${color} ${currentAngle}deg ${currentAngle + angle}deg`;
                currentAngle += angle;
                return { name, percentage: Math.round((count/totalBehaviors)*100), color, style };
            });
            const pieGradient = `conic-gradient(${pieSegments.map(s => s.style).join(', ')})`;

            return (
                <div className={`p-4 h-full flex flex-col ${getBackgroundGradient()}`}>
                    <div className="flex items-center justify-between mb-6">
                        <div>
                            <h2 className="text-3xl font-bold text-white">{getGreeting()}</h2>
                            <p className="text-slate-400 text-sm capitalize">{new Date().toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'long' })}</p>
                        </div>
                        <div className="flex items-center gap-3">
                            <div className="flex bg-slate-800 p-1 rounded-lg border border-slate-700">
                                <button onClick={() => setTimeRange('24h')} className={`px-3 py-1 rounded text-xs font-bold transition-colors ${timeRange === '24h' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>24h</button>
                                <button onClick={() => setTimeRange('7d')} className={`px-3 py-1 rounded text-xs font-bold transition-colors ${timeRange === '7d' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>7d</button>
                            </div>
                            <button onClick={onOpenSettings} className="p-2 bg-slate-800 border border-slate-700 rounded-lg text-slate-400 hover:text-white transition-colors">
                                <IconSettings />
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-6">
                        <div onClick={() => setStatsView('focus')} className="bg-gradient-to-br from-blue-500/10 to-blue-600/5 border border-blue-500/20 p-4 rounded-2xl relative overflow-hidden cursor-pointer hover:border-blue-500/40 transition-all active:scale-95">
                            <div className="absolute top-0 right-0 p-2 opacity-10"><IconTimer /></div>
                            <div className="text-blue-400 text-xs font-bold uppercase tracking-wider mb-1">Fokus</div>
                            <div className="text-3xl font-bold text-white">{totalMinutes}<span className="text-sm font-normal text-blue-200/50 ml-1">min</span></div>
                        </div>
                        <div onClick={() => setStatsView('todo')} className="bg-gradient-to-br from-green-500/10 to-green-600/5 border border-green-500/20 p-4 rounded-2xl relative overflow-hidden cursor-pointer hover:border-green-500/40 transition-all active:scale-95">
                            <div className="absolute top-0 right-0 p-2 opacity-10"><IconCheck /></div>
                            <div className="text-green-400 text-xs font-bold uppercase tracking-wider mb-1">Uppgifter</div>
                            <div className="text-3xl font-bold text-white">{totalTodos}<span className="text-sm font-normal text-green-200/50 ml-1">st</span></div>
                        </div>
                    </div>

                    <div onClick={() => setStatsView('habits')} className="bg-slate-900/50 border border-slate-800 rounded-2xl p-4 mb-6 flex justify-between items-center cursor-pointer hover:border-slate-700 transition-all">
                        <div>
                            <div className="text-purple-400 text-xs font-bold uppercase tracking-wider mb-1">{timeRange === '24h' ? 'Vanor idag' : 'Vanor denna vecka'}</div>
                            <div className="text-2xl font-bold text-white">
                                {timeRange === '24h' 
                                    ? <>{habitStats.doneToday} <span className="text-slate-500 text-lg font-normal">/ {habitStats.totalActive}</span></>
                                    : <>{habitStats.weeklyDone} <span className="text-slate-500 text-lg font-normal">/ {habitStats.weeklyTotal}</span></>
                                }
                            </div>
                        </div>
                        <div className="text-right">
                            <div className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Streak</div>
                            <div className="text-2xl font-bold text-white flex items-center justify-end gap-1">{habitStats.streak} <span className="text-lg">🔥</span></div>
                        </div>
                    </div>

                    <div onClick={() => setStatsView('graph_details')} className="bg-slate-900/50 border border-slate-800 rounded-2xl p-4 mb-6 cursor-pointer hover:border-slate-700 transition-all">
                        <div className="flex items-end justify-between h-16 gap-1">
                            {graphData.map((mins, i) => (
                                <div key={i} className="flex-1 flex flex-col justify-end group relative h-full">
                                    <div className={`w-full rounded-t-sm transition-all ${mins > 0 ? 'bg-blue-500' : 'bg-slate-800'}`} style={{height: `${(mins / maxVal) * 100}%`, minHeight: '2px'}}></div>
                                </div>
                            ))}
                        </div>
                        <div className="flex justify-between text-[10px] text-slate-500 mt-2 px-1 font-mono">{graphLabels.map((l, i) => <span key={i} className="capitalize">{l}</span>)}</div>
                    </div>

                    {totalBehaviors > 0 && (
                        <div className="bg-slate-900/50 border border-slate-800 rounded-2xl p-4 mb-6 flex items-center gap-6">
                            <div className="w-20 h-20 rounded-full flex-shrink-0 shadow-lg" style={{ background: pieGradient }}></div>
                            <div className="flex-1 space-y-1">
                                {pieSegments.slice(0, 3).map(s => (
                                    <div key={s.name} className="flex items-center justify-between text-xs">
                                        <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full" style={{backgroundColor: s.color}}></div><span className="text-slate-300 truncate max-w-[80px]">{s.name}</span></div>
                                        <span className="font-bold text-white">{s.percentage}%</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    <div className="flex-1 overflow-hidden flex flex-col">
                        <h3 className="text-slate-400 text-xs uppercase font-bold mb-3 tracking-wider text-left">Senaste händelser</h3>
                        <div className="flex-1 overflow-y-auto space-y-2 pr-1">
                            {logs.slice().reverse().filter(l => l.type === 'activity' || l.type === 'todo_done').slice(0, 20).map((l) => (
                                <div key={l.id} onClick={() => setSelectedLog(l)} className="group flex items-center justify-between text-sm bg-slate-900/50 border border-slate-800 p-3 rounded-xl cursor-pointer hover:bg-slate-800 transition-colors">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-2 h-2 rounded-full ${l.type === 'activity' ? 'bg-blue-500' : 'bg-green-500'}`}></div>
                                        <span className="text-white font-medium truncate max-w-[150px]">
                                            {l.data.goal || l.data.desc}
                                        </span>
                                    </div>
                                    <span className="text-slate-500 text-xs">{new Date(l.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    {selectedLog && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in" onClick={() => setSelectedLog(null)}>
                            <div className="bg-slate-900 border border-slate-800 rounded-2xl max-w-sm w-full shadow-2xl animate-scale-in overflow-hidden flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                                
                                {/* Header Image/Gradient Area */}
                                <div className={`h-24 flex items-center justify-center relative ${
                                    selectedLog.type === 'activity' ? 'bg-gradient-to-br from-blue-600 to-blue-900' :
                                    selectedLog.type === 'todo_done' ? 'bg-gradient-to-br from-green-600 to-green-900' :
                                    'bg-gradient-to-br from-slate-700 to-slate-900'
                                }`}>
                                    <div className="text-white/20 absolute inset-0 flex items-center justify-center overflow-hidden">
                                        <div className="scale-[3] opacity-20">
                                            {selectedLog.type === 'activity' ? <IconTimer /> : selectedLog.type === 'todo_done' ? <IconCheck /> : <IconZap />}
                                        </div>
                                    </div>
                                    <div className="z-10 flex flex-col items-center">
                                        <div className="p-3 bg-white/10 backdrop-blur-md rounded-full mb-1 shadow-lg border border-white/20 text-white">
                                            {selectedLog.type === 'activity' ? <IconTimer /> : selectedLog.type === 'todo_done' ? <IconCheck /> : <IconZap />}
                                        </div>
                                        <span className="text-white font-bold text-sm uppercase tracking-widest shadow-black/50 drop-shadow-md">
                                            {selectedLog.type === 'activity' ? 'Fokuspass' : selectedLog.type === 'todo_done' ? 'Uppgift' : 'Händelse'}
                                        </span>
                                    </div>
                                    <button onClick={() => setSelectedLog(null)} className="absolute top-4 right-4 text-white/70 hover:text-white bg-black/20 hover:bg-black/40 rounded-full p-1 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                    </button>
                                </div>

                                {/* Content Scrollable Area */}
                                <div className="p-6 overflow-y-auto">
                                    <div className="text-center mb-6">
                                        <p className="text-slate-400 text-xs font-mono mb-2">{new Date(selectedLog.created_at).toLocaleString('sv-SE', { weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' })}</p>
                                        <h3 className="text-xl font-bold text-white leading-tight">
                                            {selectedLog.data.goal || selectedLog.data.desc || selectedLog.data.behavior || selectedLog.data.name}
                                        </h3>
                                    </div>

                                    {selectedLog.type === 'activity' && (
                                        <div className="space-y-6">
                                            <div className="grid grid-cols-2 gap-3">
                                                <div className="bg-slate-800/50 p-3 rounded-xl border border-slate-700/50 flex flex-col items-center justify-center">
                                                    <span className="text-slate-400 text-[10px] uppercase font-bold tracking-wider mb-1">Längd</span>
                                                    <span className="text-xl font-bold text-blue-400">{Math.round(selectedLog.data.durationSeconds / 60)} <span className="text-xs text-slate-500">min</span></span>
                                                </div>
                                                <div className="bg-slate-800/50 p-3 rounded-xl border border-slate-700/50 flex flex-col items-center justify-center">
                                                    <span className="text-slate-400 text-[10px] uppercase font-bold tracking-wider mb-1">Resultat</span>
                                                    <span className={`text-xl font-bold ${selectedLog.data.success ? 'text-green-400' : 'text-red-400'}`}>{selectedLog.data.success ? 'Lyckades' : 'Misslyckades'}</span>
                                                </div>
                                            </div>

                                            <div className="space-y-3">
                                                <div>
                                                    <div className="flex justify-between text-xs mb-1"><span className="text-slate-400">Motivation</span><span className="text-white font-bold">{selectedLog.data.motivation}%</span></div>
                                                    <div className="h-2 bg-slate-800 rounded-full overflow-hidden"><div className="h-full bg-blue-500 rounded-full" style={{width: `${selectedLog.data.motivation}%`}}></div></div>
                                                </div>
                                                <div>
                                                    <div className="flex justify-between text-xs mb-1"><span className="text-slate-400">Nöjdhet</span><span className="text-white font-bold">{selectedLog.data.satisfaction}%</span></div>
                                                    <div className="h-2 bg-slate-800 rounded-full overflow-hidden"><div className="h-full bg-purple-500 rounded-full" style={{width: `${selectedLog.data.satisfaction}%`}}></div></div>
                                                </div>
                                            </div>

                                            {selectedLog.data.challenges && (
                                                <div className="bg-red-900/10 border border-red-500/20 p-3 rounded-xl">
                                                    <p className="text-red-400 text-xs font-bold uppercase mb-1">Utmaningar</p>
                                                    <p className="text-slate-300 text-sm italic">"{selectedLog.data.challenges}"</p>
                                                </div>
                                            )}

                                            {selectedLog.data.behaviors && selectedLog.data.behaviors.length > 0 && (
                                                <div className="bg-slate-800/30 rounded-xl p-4 border border-slate-800">
                                                    <p className="text-slate-400 text-xs font-bold uppercase mb-3">Loggade beteenden</p>
                                                    <div className="space-y-3 relative before:absolute before:left-[5px] before:top-2 before:bottom-2 before:w-[1px] before:bg-slate-700">
                                                        {selectedLog.data.behaviors.map((b, i) => (
                                                            <div key={i} className="flex items-start gap-3 relative pl-1">
                                                                <div className="w-2.5 h-2.5 rounded-full bg-slate-600 border-2 border-slate-900 mt-1 z-10 shrink-0"></div>
                                                                <div>
                                                                    <p className="text-slate-200 text-sm font-medium">{b.behavior}</p>
                                                                    <p className="text-slate-500 text-xs">{new Date(b.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {selectedLog.type === 'todo_done' && (
                                        <div className="space-y-6">
                                            <div className="flex justify-center">
                                                <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider border ${
                                                    selectedLog.data.priority === 'high' ? 'bg-red-900/20 border-red-500/30 text-red-400' :
                                                    selectedLog.data.priority === 'medium' ? 'bg-yellow-900/20 border-yellow-500/30 text-yellow-400' :
                                                    'bg-green-900/20 border-green-500/30 text-green-400'
                                                }`}>
                                                    {selectedLog.data.priority === 'high' ? 'Hög Prioritet' : selectedLog.data.priority === 'medium' ? 'Medel Prioritet' : 'Låg Prioritet'}
                                                </span>
                                            </div>
                                            
                                            <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 flex items-center justify-between">
                                                <span className="text-slate-400 text-sm font-medium">Estimerad tidsåtgång</span>
                                                <span className="text-xl font-bold text-white">{selectedLog.data.minutes} <span className="text-xs text-slate-500 font-normal">min</span></span>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Footer Actions */}
                                <div className="p-4 bg-slate-900 border-t border-slate-800 flex gap-3">
                                    <button className="flex-1 py-3 rounded-xl font-bold text-slate-400 hover:text-white hover:bg-slate-800 transition-colors" onClick={() => setSelectedLog(null)}>Stäng</button>
                                    <button className="flex-1 py-3 rounded-xl font-bold text-red-400 hover:text-white hover:bg-red-600 bg-red-900/20 border border-red-900/50 hover:border-red-500 transition-all active:scale-95" onClick={async () => {
                                        if(confirm("Ta bort händelse?")) {
                                            await deleteLog(selectedLog.id);
                                            setSelectedLog(null);
                                        }
                                    }}>Ta bort</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {statsView && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in" onClick={closeStatsView}>
                            <div className="bg-slate-900 border border-slate-800 rounded-2xl max-w-sm w-full shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-scale-in" onClick={e => e.stopPropagation()}>
                                {statsView === 'focus' && (() => {
                                    const numSessions = recentActivity.length;
                                    const avgLength = numSessions > 0 ? Math.round(totalMinutes / numSessions) : 0;
                                    const successRate = numSessions > 0 ? Math.round(recentActivity.filter(s => s.data.success).length / numSessions * 100) : 0;
                                    const avgMotivation = numSessions > 0 ? Math.round(recentActivity.reduce((a,c) => a + c.data.motivation, 0) / numSessions) : 0;
                                    const avgSatisfaction = numSessions > 0 ? Math.round(recentActivity.reduce((a,c) => a + c.data.satisfaction, 0) / numSessions) : 0;

                                    return (
                                        <div className="flex flex-col h-full">
                                            <div className="h-24 bg-gradient-to-br from-blue-600 to-blue-900 flex items-center justify-center relative shrink-0">
                                                <div className="text-white/20 absolute inset-0 flex items-center justify-center overflow-hidden">
                                                    <div className="scale-[3] opacity-20"><IconTimer /></div>
                                                </div>
                                                <div className="z-10 flex flex-col items-center">
                                                    <span className="text-white font-bold text-lg shadow-black/50 drop-shadow-md">Fokusanalys</span>
                                                    <span className="text-blue-200 text-xs uppercase tracking-widest">{timeRange === '24h' ? 'Senaste dygnet' : 'Senaste 7 dagarna'}</span>
                                                </div>
                                                <button onClick={closeStatsView} className="absolute top-4 right-4 text-white/70 hover:text-white bg-black/20 hover:bg-black/40 rounded-full p-1 transition-colors">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                                </button>
                                            </div>

                                            <div className="p-6 overflow-y-auto space-y-6">
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 flex flex-col items-center justify-center">
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold tracking-wider mb-1">Total tid</span>
                                                        <span className="text-3xl font-bold text-blue-400">{totalMinutes}<span className="text-sm text-slate-500 ml-1">min</span></span>
                                                    </div>
                                                    <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 flex flex-col items-center justify-center">
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold tracking-wider mb-1">Antal pass</span>
                                                        <span className="text-3xl font-bold text-white">{numSessions}</span>
                                                    </div>
                                                </div>
                                                
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div className="bg-slate-800/30 p-4 rounded-xl border border-slate-800 flex flex-col items-center justify-center">
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold tracking-wider mb-1">Snittlängd</span>
                                                        <span className="text-xl font-bold text-white">{avgLength} <span className="text-xs text-slate-500 font-normal">min</span></span>
                                                    </div>
                                                    <div className="bg-slate-800/30 p-4 rounded-xl border border-slate-800 flex flex-col items-center justify-center">
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold tracking-wider mb-1">Lyckade pass</span>
                                                        <span className={`text-xl font-bold ${successRate >= 80 ? 'text-green-400' : successRate >= 50 ? 'text-yellow-400' : 'text-red-400'}`}>{successRate}%</span>
                                                    </div>
                                                </div>

                                                <div className="space-y-3">
                                                    <div><div className="flex justify-between text-xs mb-1"><span className="text-slate-400">Snittmotivation</span><span className="text-white font-bold">{avgMotivation}%</span></div><div className="h-2 bg-slate-800 rounded-full overflow-hidden"><div className="h-full bg-blue-500 rounded-full" style={{width: `${avgMotivation}%`}}></div></div></div>
                                                    <div><div className="flex justify-between text-xs mb-1"><span className="text-slate-400">Snittnöjdhet</span><span className="text-white font-bold">{avgSatisfaction}%</span></div><div className="h-2 bg-slate-800 rounded-full overflow-hidden"><div className="h-full bg-purple-500 rounded-full" style={{width: `${avgSatisfaction}%`}}></div></div></div>
                                                </div>
                                            </div>
                                            
                                            <div className="p-4 border-t border-slate-800 mt-auto"><button className="btn-secondary w-full" onClick={closeStatsView}>Stäng</button></div>
                                        </div>
                                    );
                                })()}
                                {statsView === 'todo' && (() => {
                                    const priorityCounts = recentTodos.reduce((acc, todo) => {
                                        acc[todo.data.priority] = (acc[todo.data.priority] || 0) + 1;
                                        return acc;
                                    }, { high: 0, medium: 0, low: 0 });
                                    const total = priorityCounts.high + priorityCounts.medium + priorityCounts.low;
                                    
                                    const totalTime = recentTodos.reduce((acc, t) => acc + (parseInt(t.data.minutes) || 0), 0);
                                    const avgTime = total > 0 ? Math.round(totalTime / total) : 0;

                                    const timeOfDay = { morning: 0, afternoon: 0, evening: 0 };
                                    recentTodos.forEach(t => {
                                        const h = new Date(t.created_at).getHours();
                                        if (h >= 5 && h < 12) timeOfDay.morning++;
                                        else if (h >= 12 && h < 18) timeOfDay.afternoon++;
                                        else timeOfDay.evening++;
                                    });
                                    
                                    const getPct = (val, tot) => tot > 0 ? Math.round((val/tot)*100) : 0;

                                    return (
                                        <div className="flex flex-col h-full">
                                            <div className="h-24 bg-gradient-to-br from-green-600 to-green-900 flex items-center justify-center relative shrink-0">
                                                <div className="text-white/20 absolute inset-0 flex items-center justify-center overflow-hidden">
                                                    <div className="scale-[3] opacity-20"><IconCheck /></div>
                                                </div>
                                                <div className="z-10 flex flex-col items-center">
                                                    <span className="text-white font-bold text-lg shadow-black/50 drop-shadow-md">Uppgiftsanalys</span>
                                                    <span className="text-green-200 text-xs uppercase tracking-widest">{timeRange === '24h' ? 'Senaste dygnet' : 'Senaste 7 dagarna'}</span>
                                                </div>
                                                <button onClick={closeStatsView} className="absolute top-4 right-4 text-white/70 hover:text-white bg-black/20 hover:bg-black/40 rounded-full p-1 transition-colors">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                                </button>
                                            </div>

                                            <div className="p-6 overflow-y-auto space-y-6">
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 flex flex-col items-center justify-center">
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold tracking-wider mb-1">Avklarade</span>
                                                        <span className="text-3xl font-bold text-white">{total}</span>
                                                    </div>
                                                    <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 flex flex-col items-center justify-center">
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold tracking-wider mb-1">Total Tid</span>
                                                        <span className="text-3xl font-bold text-green-400">{totalTime}<span className="text-sm text-slate-500 ml-1">min</span></span>
                                                    </div>
                                                </div>
                                                
                                                <div className="bg-slate-800/30 p-4 rounded-xl border border-slate-800 flex justify-between items-center">
                                                    <span className="text-slate-400 text-sm font-medium">Snittid per uppgift</span>
                                                    <span className="text-xl font-bold text-white">{avgTime} <span className="text-xs text-slate-500 font-normal">min</span></span>
                                                </div>

                                                <div>
                                                    <h4 className="text-slate-400 text-xs uppercase font-bold mb-3 tracking-wider">Prioritetsfördelning</h4>
                                                    <div className="space-y-3">
                                                        {[
                                                            { label: 'Hög', count: priorityCounts.high, color: 'bg-red-500', bg: 'bg-red-900/20' },
                                                            { label: 'Medel', count: priorityCounts.medium, color: 'bg-yellow-500', bg: 'bg-yellow-900/20' },
                                                            { label: 'Låg', count: priorityCounts.low, color: 'bg-green-500', bg: 'bg-green-900/20' }
                                                        ].map(p => (
                                                            <div key={p.label} className="relative">
                                                                <div className="flex justify-between text-xs mb-1 z-10 relative">
                                                                    <span className="text-slate-300 font-medium">{p.label}</span>
                                                                    <span className="text-slate-400">{p.count} st ({getPct(p.count, total)}%)</span>
                                                                </div>
                                                                <div className={`h-2 w-full rounded-full overflow-hidden ${p.bg}`}>
                                                                    <div className={`h-full rounded-full ${p.color}`} style={{width: `${getPct(p.count, total)}%`}}></div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>

                                                <div>
                                                    <h4 className="text-slate-400 text-xs uppercase font-bold mb-3 tracking-wider">Tid på dygnet</h4>
                                                    <div className="grid grid-cols-3 gap-2">
                                                        {[
                                                            { label: 'Fm', count: timeOfDay.morning, icon: '🌅' },
                                                            { label: 'Em', count: timeOfDay.afternoon, icon: '☀️' },
                                                            { label: 'Kväll', count: timeOfDay.evening, icon: '🌙' }
                                                        ].map(t => (
                                                            <div key={t.label} className={`p-2 rounded-xl border text-center ${t.count > 0 ? 'bg-slate-800 border-slate-700' : 'bg-slate-900/30 border-slate-800 opacity-50'}`}>
                                                                <div className="text-lg mb-1">{t.icon}</div>
                                                                <div className="text-xs text-slate-400 uppercase font-bold">{t.label}</div>
                                                                <div className="text-lg font-bold text-white">{t.count}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div className="p-4 border-t border-slate-800 mt-auto">
                                                <button className="btn-secondary w-full" onClick={closeStatsView}>Stäng</button>
                                            </div>
                                        </div>
                                    );
                                })()}
                                {statsView === 'habits' && (() => {
                                    const days = [];
                                    const dataPoints = [];
                                    for (let i = 6; i >= 0; i--) {
                                        const d = new Date();
                                        d.setDate(d.getDate() - i);
                                        const dateStr = d.toISOString().split('T')[0];
                                        days.push(d.toLocaleDateString('sv-SE', { weekday: 'short' }));
                                        const count = logs.filter(l => l.type === 'habit_done' && l.created_at.startsWith(dateStr)).length;
                                        dataPoints.push(count);
                                    }
                                    
                                    const maxVal = Math.max(...dataPoints, 1);
                                    const points = dataPoints.map((val, i) => {
                                        const x = (i / (dataPoints.length - 1)) * 100;
                                        const y = 100 - ((val / maxVal) * 80);
                                        return `${x},${y}`;
                                    }).join(' ');

                                    return (
                                        <div className="flex flex-col h-full">
                                            <div className="h-24 bg-gradient-to-br from-purple-600 to-purple-900 flex items-center justify-center relative shrink-0">
                                                <div className="z-10 flex flex-col items-center">
                                                    <span className="text-white font-bold text-lg shadow-black/50 drop-shadow-md">Vanoanalys</span>
                                                    <span className="text-purple-200 text-xs uppercase tracking-widest">Senaste 7 dagarna</span>
                                                </div>
                                                <button onClick={closeStatsView} className="absolute top-4 right-4 text-white/70 hover:text-white bg-black/20 hover:bg-black/40 rounded-full p-1 transition-colors">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                                </button>
                                            </div>

                                            <div className="p-6 overflow-y-auto space-y-6">
                                                <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50">
                                                     <h4 className="text-slate-400 text-xs uppercase font-bold mb-4 tracking-wider">Utveckling</h4>
                                                     <div className="h-40 w-full relative px-2 border-b border-l border-slate-700/50">
                                                        <svg viewBox="0 0 100 100" preserveAspectRatio="none" className="absolute inset-0 w-full h-full overflow-visible">
                                                            <polyline points={points} fill="none" stroke="#a855f7" strokeWidth="2" vectorEffect="non-scaling-stroke" />
                                                        </svg>
                                                        {dataPoints.map((val, i) => {
                                                            const x = (i / (dataPoints.length - 1)) * 100;
                                                            const y = 100 - ((val / maxVal) * 80);
                                                            return (
                                                                <div key={i} className="absolute w-2 h-2 bg-white border-2 border-purple-500 rounded-full -ml-1 -mt-1" style={{left: `${x}%`, top: `${y}%`}} title={`${val} st`}></div>
                                                            );
                                                        })}
                                                        <div className="flex justify-between absolute -bottom-6 left-0 right-0 text-[10px] text-slate-400 font-mono uppercase">
                                                            {days.map((d, i) => <span key={i}>{d}</span>)}
                                                        </div>
                                                     </div>
                                                     <div className="h-4"></div>
                                                </div>
                                                
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 flex flex-col items-center justify-center">
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold tracking-wider mb-1">Totalt (7d)</span>
                                                        <span className="text-3xl font-bold text-purple-400">{habitStats.weeklyDone}</span>
                                                    </div>
                                                    <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 flex flex-col items-center justify-center">
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold tracking-wider mb-1">Streak</span>
                                                        <span className="text-3xl font-bold text-white">{habitStats.streak}🔥</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div className="p-4 border-t border-slate-800 mt-auto">
                                                <button className="btn-secondary w-full" onClick={closeStatsView}>Stäng</button>
                                            </div>
                                        </div>
                                    );
                                })()}
                                {statsView === 'graph_details' && (() => {
                                    let selectedSessions = [];
                                    let title = '';

                                    if (selectedGraphBarIndex !== null) {
                                        if (timeRange === '24h') {
                                            title = `Fokuspass kl. ${selectedGraphBarIndex}:00 - ${selectedGraphBarIndex}:59`;
                                            selectedSessions = recentActivity.filter(l => new Date(l.created_at).getHours() === selectedGraphBarIndex);
                                        } else { // 7d
                                            const selectedDate = days[selectedGraphBarIndex];
                                            const selectedDateStr = selectedDate.toISOString().split('T')[0];
                                            title = `Fokuspass för ${selectedDate.toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'short' })}`;
                                            selectedSessions = recentActivity.filter(l => new Date(l.created_at).toISOString().split('T')[0] === selectedDateStr);
                                        }
                                    }

                                    return (
                                        <div className="flex flex-col h-full">
                                            <div className="h-24 bg-gradient-to-br from-blue-600 to-blue-900 flex items-center justify-center relative shrink-0">
                                                <div className="z-10 flex flex-col items-center">
                                                    <span className="text-white font-bold text-lg shadow-black/50 drop-shadow-md">Tidsanalys</span>
                                                    <span className="text-blue-200 text-xs uppercase tracking-widest">{timeRange === '24h' ? 'Senaste dygnet' : 'Senaste 7 dagarna'}</span>
                                                </div>
                                                <button onClick={closeStatsView} className="absolute top-4 right-4 text-white/70 hover:text-white bg-black/20 hover:bg-black/40 rounded-full p-1 transition-colors">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                                </button>
                                            </div>

                                            <div className="p-6 overflow-y-auto space-y-6">
                                                {/* The graph itself */}
                                                <div>
                                                    <div className="flex items-end justify-between h-40 gap-1">
                                                        {graphData.map((mins, i) => (
                                                            <div key={i} onClick={() => setSelectedGraphBarIndex(i)} className="flex-1 flex flex-col justify-end group relative h-full cursor-pointer">
                                                                <div className={`w-full rounded-t-sm transition-all ${mins > 0 ? 'bg-blue-500' : 'bg-slate-800'} ${selectedGraphBarIndex === i ? 'ring-2 ring-offset-2 ring-offset-slate-900 ring-blue-400' : 'hover:bg-blue-400'}`} style={{height: `${(mins / maxVal) * 100}%`, minHeight: '2px'}}></div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                    <div className="flex justify-between text-[10px] text-slate-500 mt-2 px-1 font-mono">{graphLabels.map((l, i) => <span key={i} className="capitalize">{l}</span>)}</div>
                                                </div>

                                                {/* Details for selected bar */}
                                                {selectedGraphBarIndex !== null && (
                                                    <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-800 animate-fade-in">
                                                        <h4 className="text-slate-300 text-xs font-bold uppercase mb-3 tracking-wider">{title}</h4>
                                                        <div className="space-y-2">
                                                            {selectedSessions.length === 0 && <p className="text-slate-500 text-sm italic">Inga pass under denna period.</p>}
                                                            {selectedSessions.map(l => (
                                                                <div key={l.id} className="flex justify-between items-center text-sm bg-slate-900/50 p-2 rounded-lg">
                                                                    <span className="text-white font-medium truncate max-w-[200px]">{l.data.goal}</span>
                                                                    <span className="text-slate-400 font-mono">{Math.round(l.data.durationSeconds / 60)} min</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}

                                                {selectedGraphBarIndex === null && (
                                                    <div className="text-center text-slate-500 text-sm pt-8">
                                                        <p>Klicka på en stapel för att se detaljer.</p>
                                                    </div>
                                                )}
                                            </div>

                                            <div className="p-4 border-t border-slate-800 mt-auto">
                                                <button className="btn-secondary w-full" onClick={closeStatsView}>Stäng</button>
                                            </div>
                                        </div>
                                    );
                                })()}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 4. To-do List
        const TodoList = ({ todos, onStartTodo, addTodo, completeTodo, deleteTodo, saveTodoEdit }) => {
            const [newTodo, setNewTodo] = useState({ desc: '', minutes: '', priority: 'medium', details: '' });
            const [isAdding, setIsAdding] = useState(false);
            const [editingTodo, setEditingTodo] = useState(null);
            const [viewingTodo, setViewingTodo] = useState(null);
            const longPressTimer = useRef(null);
            const isLongPress = useRef(false);

            const handleLongPressStart = (e, todo) => {
                if (e.target.closest('button')) return; // Ignorera om man klickar på knappar
                isLongPress.current = false;
                longPressTimer.current = setTimeout(() => {
                    isLongPress.current = true;
                    setEditingTodo(todo);
                }, 500);
            };

            const handleLongPressEnd = () => {
                if (longPressTimer.current) clearTimeout(longPressTimer.current);
            };

            const pColors = { high: 'border-l-red-500 bg-red-900/10', medium: 'border-l-yellow-500 bg-yellow-900/10', low: 'border-l-green-500 bg-green-900/10' };
            const pLabels = { high: 'Hög', medium: 'Medel', low: 'Låg' };

            return (
                <div className="p-4 h-full flex flex-col relative">
                    <div className="mb-6">
                        <h2 className="text-3xl font-bold text-white">Att göra</h2>
                    </div>

                    <div className="flex-1 overflow-y-auto space-y-3 pb-20">
                        {todos.length === 0 && <p className="text-center text-slate-500 mt-10 text-sm">Inget att göra.</p>}
                        {[...todos].sort((a, b) => ({ 'high': 1, 'medium': 2, 'low': 3 }[a.priority] - { 'high': 1, 'medium': 2, 'low': 3 }[b.priority])).map(t => (
                            <div 
                                key={t.id} 
                                onMouseDown={(e) => handleLongPressStart(e, t)}
                                onMouseUp={handleLongPressEnd}
                                onMouseLeave={handleLongPressEnd}
                                onTouchStart={(e) => handleLongPressStart(e, t)}
                                onTouchEnd={handleLongPressEnd}
                                onTouchMove={handleLongPressEnd}
                                onClick={(e) => {
                                    if (e.target.closest('button')) return;
                                    if (!isLongPress.current) setViewingTodo(t);
                                }}
                                className={`bg-slate-900/50 border-l-4 ${pColors[t.priority]} rounded-r-xl p-4 flex justify-between items-center border-y border-r border-slate-800/50 select-none active:scale-[0.99] transition-transform cursor-pointer`}>
                                <div>
                                    <h3 className="font-bold text-lg text-white">{t.desc}</h3>
                                    <div className="flex gap-3 text-xs text-slate-400 mt-1">
                                        <span className="flex items-center gap-1">{t.minutes} min</span>
                                        <span className="uppercase font-bold tracking-wider self-center px-2 py-0.5 rounded bg-slate-800">{pLabels[t.priority]}</span>
                                    </div>
                                </div>
                                <div className="flex items-center">
                                    <button onClick={(e) => { e.stopPropagation(); onStartTodo(t); }} className="text-slate-400 hover:text-blue-400 p-2 transition-colors" title="Starta"><IconPlay /></button>
                                    <button onClick={(e) => { e.stopPropagation(); completeTodo(t); }} className="text-slate-400 hover:text-green-400 p-2 transition-colors" title="Klar"><IconCheck /></button>
                                    <button onClick={(e) => { e.stopPropagation(); deleteTodo(t.id); }} className="text-slate-400 hover:text-red-400 p-2 transition-colors"><IconTrash /></button>
                                </div>
                            </div>
                        ))}
                    </div>

                    <button 
                        onClick={() => setIsAdding(true)}
                        className="absolute bottom-6 right-6 w-14 h-14 bg-blue-600 hover:bg-blue-500 rounded-full flex items-center justify-center shadow-lg text-white transition-transform active:scale-90 z-10"
                    >
                        <IconPlus />
                    </button>

                    {isAdding && (
                        <div className="fixed inset-0 bg-slate-950/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in" onClick={() => setIsAdding(false)}>
                            <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl animate-scale-in text-center" onClick={e => e.stopPropagation()}>
                                <h3 className="text-2xl font-bold mb-6 text-white">Ny uppgift</h3>
                                <input className="input-field text-center !py-3 !mb-3" placeholder="Aktivitet" autoFocus value={newTodo.desc} onChange={e => setNewTodo({...newTodo, desc: e.target.value})} />
                                <input type="number" className="input-field text-center !py-3 !mb-3" placeholder="Tid (min)?" value={newTodo.minutes} onChange={e => setNewTodo({...newTodo, minutes: e.target.value})} />
                                <textarea className="input-field text-center !py-3 !mb-3 min-h-[80px] resize-none" placeholder="Beskrivning / Anteckningar (valfritt)" value={newTodo.details || ''} onChange={e => setNewTodo({...newTodo, details: e.target.value})} />
                                <div className="flex gap-2 justify-center mb-4 mt-2">
                                    {['high', 'medium', 'low'].map(p => (
                                        <button key={p} onClick={() => setNewTodo({...newTodo, priority: p})} className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${newTodo.priority === p ? (p === 'high' ? 'bg-red-600 text-white shadow' : p === 'medium' ? 'bg-yellow-600 text-white shadow' : 'bg-green-600 text-white shadow') : 'bg-slate-800 text-slate-400'}`}>{pLabels[p]}</button>
                                    ))}
                                </div>
                                <div className="flex gap-2 mt-4">
                                    <button onClick={() => setIsAdding(false)} className="btn-secondary">Avbryt</button>
                                    <button disabled={!newTodo.desc || !newTodo.minutes} className={`w-full font-bold text-lg py-3 rounded-xl transition-colors ${(!newTodo.desc || !newTodo.minutes) ? 'bg-slate-800 text-slate-600 cursor-not-allowed' : 'bg-gradient-to-r from-orange-500 to-orange-600 text-white'}`} onClick={async () => {
                                        await addTodo(newTodo);
                                        setNewTodo({ desc: '', minutes: '', priority: 'medium', details: '' });
                                        setIsAdding(false);
                                    }}>Skapa</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {editingTodo && (
                        <div className="fixed inset-0 bg-slate-950/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in" onClick={() => setEditingTodo(null)}>
                            <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl animate-scale-in text-center" onClick={e => e.stopPropagation()}>
                                <h3 className="text-2xl font-bold mb-6 text-white">Redigera uppgift</h3>
                                <input className="input-field text-center !py-3 !mb-3" placeholder="Aktivitet" autoFocus value={editingTodo.desc} onChange={e => setEditingTodo({...editingTodo, desc: e.target.value})} />
                                <input type="number" className="input-field text-center !py-3 !mb-3" placeholder="Tid (min)?" value={editingTodo.minutes} onChange={e => setEditingTodo({...editingTodo, minutes: e.target.value})} />
                                <textarea className="input-field text-center !py-3 !mb-3 min-h-[80px] resize-none" placeholder="Beskrivning / Anteckningar" value={editingTodo.details || ''} onChange={e => setEditingTodo({...editingTodo, details: e.target.value})} />
                                <div className="flex gap-2 justify-center mb-4 mt-2">
                                    {['high', 'medium', 'low'].map(p => (
                                        <button key={p} onClick={() => setEditingTodo({...editingTodo, priority: p})} className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${editingTodo.priority === p ? (p === 'high' ? 'bg-red-600 text-white shadow' : p === 'medium' ? 'bg-yellow-600 text-white shadow' : 'bg-green-600 text-white shadow') : 'bg-slate-800 text-slate-400'}`}>{pLabels[p]}</button>
                                    ))}
                                </div>
                                <div className="flex gap-2 mt-4">
                                    <button onClick={() => setEditingTodo(null)} className="btn-secondary">Avbryt</button>
                                    <button disabled={!editingTodo.desc || !editingTodo.minutes} className={`w-full font-bold text-lg py-3 rounded-xl transition-colors ${(!editingTodo.desc || !editingTodo.minutes) ? 'bg-slate-800 text-slate-600 cursor-not-allowed' : 'bg-gradient-to-r from-orange-500 to-orange-600 text-white'}`} onClick={async () => {
                                        await saveTodoEdit(editingTodo);
                                        setEditingTodo(null);
                                    }}>Spara</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {viewingTodo && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in" onClick={() => setViewingTodo(null)}>
                            <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl animate-scale-in" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-start mb-4">
                                    <h3 className="text-2xl font-bold text-white">{viewingTodo.desc}</h3>
                                    <span className={`px-2 py-1 rounded text-xs font-bold uppercase ${viewingTodo.priority === 'high' ? 'bg-red-900/30 text-red-400' : viewingTodo.priority === 'medium' ? 'bg-yellow-900/30 text-yellow-400' : 'bg-green-900/30 text-green-400'}`}>{pLabels[viewingTodo.priority]}</span>
                                </div>
                                <div className="bg-slate-800/50 rounded-xl p-4 mb-6 border border-slate-800">
                                    <p className="text-slate-400 text-xs font-bold uppercase mb-2">Beskrivning</p>
                                    <p className="text-slate-200 whitespace-pre-wrap">{viewingTodo.details || <span className="italic text-slate-500">Ingen beskrivning.</span>}</p>
                                </div>
                                <div className="flex justify-between items-center text-sm text-slate-400 mb-6">
                                    <span>Estimerad tid: <span className="text-white font-bold">{viewingTodo.minutes} min</span></span>
                                </div>
                                <button className="btn-secondary w-full" onClick={() => setViewingTodo(null)}>Stäng</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 5. Habit Tracker
        const HabitTracker = ({ habits, logs, addHabit, toggleHabit, saveHabitEdit, deleteHabit }) => {
            const [newHabit, setNewHabit] = useState('');
            const [isAdding, setIsAdding] = useState(false);
            const [editingHabit, setEditingHabit] = useState(null);
            const longPressTimer = useRef(null);
            const isLongPress = useRef(false);
            const [view, setView] = useState('list');
            const [calendarDate, setCalendarDate] = useState(new Date());

            const handleLongPressStart = (habit) => {
                isLongPress.current = false;
                longPressTimer.current = setTimeout(() => {
                    isLongPress.current = true;
                    setEditingHabit(habit);
                }, 500);
            };

            const handleLongPressEnd = () => {
                if (longPressTimer.current) clearTimeout(longPressTimer.current);
            };

            const handleHabitClick = (habitId) => {
                if (isLongPress.current) return;
                toggleHabit(habitId);
            };

            const getTodayString = () => new Date().toISOString().split('T')[0];

            const todayStr = getTodayString();
            const completedTodayIds = new Set(
                logs
                    .filter(l => l.type === 'habit_done' && l.created_at.startsWith(todayStr))
                    .map(l => l.data.habitId)
            );

            const habitsWithStatus = habits.map(h => ({
                ...h,
                completed: completedTodayIds.has(h.id)
            }));

            const sortedHabits = [...habitsWithStatus].sort((a, b) => a.completed - b.completed);

            return (
                <div className="p-4 h-full flex flex-col relative">
                    <div className="mb-6 flex justify-between items-start">
                        <h2 className="text-3xl font-bold text-white">Vanor</h2>
                        <button onClick={() => setView(view === 'list' ? 'calendar' : 'list')} className="p-2 bg-slate-900 border border-slate-800 rounded-xl text-slate-400 hover:text-white transition-colors">
                            {view === 'list' ? <IconCalendar /> : <IconList />}
                        </button>
                    </div>

                    {view === 'list' ? (
                    <div className="flex-1 overflow-y-auto space-y-3 pb-20">
                        {habits.length === 0 && <p className="text-center text-slate-500 mt-10 text-sm">Lägg till din första vana.</p>}
                        {sortedHabits.map(habit => (
                            <div 
                                key={habit.id} 
                                onClick={() => handleHabitClick(habit.id)} 
                                onMouseDown={() => handleLongPressStart(habit)}
                                onMouseUp={handleLongPressEnd}
                                onMouseLeave={handleLongPressEnd}
                                onTouchStart={() => handleLongPressStart(habit)}
                                onTouchEnd={handleLongPressEnd}
                                onTouchMove={handleLongPressEnd}
                                className={`p-4 rounded-2xl flex justify-between items-center cursor-pointer transition-all border select-none active:scale-[0.99] ${habit.completed ? 'bg-green-900/20 border-green-500/30' : 'bg-slate-900/50 border-slate-800 hover:border-slate-700'}`}>
                                <span className={`text-lg font-medium ${habit.completed ? 'line-through text-slate-500' : 'text-white'}`}>{habit.name}</span>
                                <div className={`w-6 h-6 rounded-full flex items-center justify-center border-2 transition-colors ${habit.completed ? 'bg-green-500 border-green-500 text-white' : 'border-slate-600 text-transparent'}`}>
                                    {habit.completed && <IconCheck />}
                                </div>
                            </div>
                        ))}
                    </div>
                    ) : (
                        <div className="flex-1 overflow-y-auto pb-20">
                            <div className="flex justify-between items-center mb-6 px-2">
                                <button onClick={() => setCalendarDate(new Date(calendarDate.getFullYear(), calendarDate.getMonth() - 1, 1))} className="p-2 hover:text-white text-slate-400"><IconChevronLeft /></button>
                                <span className="font-bold capitalize text-white text-lg">{calendarDate.toLocaleDateString('sv-SE', { month: 'long', year: 'numeric' })}</span>
                                <button onClick={() => setCalendarDate(new Date(calendarDate.getFullYear(), calendarDate.getMonth() + 1, 1))} className="p-2 hover:text-white text-slate-400"><IconChevronRight /></button>
                            </div>
                            <div className="grid grid-cols-7 gap-2 text-center mb-3">
                                {['M', 'T', 'O', 'T', 'F', 'L', 'S'].map(d => <span key={d} className="text-xs text-slate-500 font-bold">{d}</span>)}
                            </div>
                            <div className="grid grid-cols-7 gap-2">
                                {(() => {
                                    const year = calendarDate.getFullYear();
                                    const month = calendarDate.getMonth();
                                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                                    const firstDay = (new Date(year, month, 1).getDay() + 6) % 7;
                                    
                                    const cells = [];
                                    for (let i = 0; i < firstDay; i++) cells.push(<div key={`empty-${i}`}></div>);
                                    for (let i = 1; i <= daysInMonth; i++) {
                                        const dateStr = new Date(year, month, i).toISOString().split('T')[0];
                                        const doneCount = logs.filter(l => l.type === 'habit_done' && l.created_at.startsWith(dateStr)).length;
                                        const isToday = dateStr === getTodayString();
                                        
                                        let bgClass = 'bg-slate-900/50 border-slate-800 text-slate-500';
                                        if (doneCount > 0) bgClass = 'bg-green-900/30 border-green-500/30 text-green-400';
                                        if (doneCount >= 3) bgClass = 'bg-green-600 border-green-500 text-white shadow-lg shadow-green-900/50';

                                        cells.push(
                                            <div key={i} className={`aspect-square rounded-xl border flex items-center justify-center text-sm font-bold relative transition-all ${bgClass} ${isToday ? 'ring-2 ring-blue-500 z-10' : ''}`}>
                                                {i}
                                            </div>
                                        );
                                    }
                                    return cells;
                                })()}
                            </div>
                        </div>
                    )}
                    
                    <button 
                        onClick={() => setIsAdding(true)}
                        className="absolute bottom-6 right-6 w-14 h-14 bg-blue-600 hover:bg-blue-500 rounded-full flex items-center justify-center shadow-lg text-white transition-transform active:scale-90 z-10"
                    >
                        <IconPlus />
                    </button>

                    {isAdding && (
                        <div className="fixed inset-0 bg-slate-950/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in" onClick={() => setIsAdding(false)}>
                            <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl animate-scale-in text-center" onClick={e => e.stopPropagation()}>
                                <h3 className="text-2xl font-bold mb-6 text-white">Ny vana</h3>
                                <input 
                                    className="input-field text-center !py-3 !mb-3" 
                                    placeholder="Vad vill du göra?" 
                                    autoFocus
                                    value={newHabit} 
                                    onChange={e => setNewHabit(e.target.value)}
                                    onKeyPress={e => e.key === 'Enter' && addHabit()}
                                />
                                <div className="flex gap-2 mt-4">
                                    <button onClick={() => setIsAdding(false)} className="btn-secondary">Avbryt</button>
                                    <button onClick={async () => {
                                        await addHabit(newHabit);
                                        setNewHabit('');
                                        setIsAdding(false);
                                    }} className="w-full font-bold text-lg py-3 rounded-xl transition-colors bg-gradient-to-r from-orange-500 to-orange-600 text-white">Spara</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {editingHabit && (
                        <div className="fixed inset-0 bg-slate-950/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in" onClick={() => setEditingHabit(null)}>
                            <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl animate-scale-in text-center" onClick={e => e.stopPropagation()}>
                                <h3 className="text-2xl font-bold mb-6 text-white">Redigera vana</h3>
                                <input 
                                    className="input-field text-center !py-3 !mb-3" 
                                    placeholder="Vad vill du göra?" 
                                    autoFocus
                                    value={editingHabit.name} 
                                    onChange={e => setEditingHabit({...editingHabit, name: e.target.value})}
                                />
                                <div className="flex gap-2 mt-4">
                                    <button onClick={() => setEditingHabit(null)} className="btn-secondary">Avbryt</button>
                                    <button onClick={async () => {
                                        if(confirm("Vill du ta bort denna vana?")) {
                                            await deleteHabit(editingHabit.id);
                                            setEditingHabit(null);
                                        }
                                    }} className="bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-4 rounded-xl transition-colors active:scale-95 flex-1">Ta bort</button>
                                    <button onClick={async () => {
                                        await saveHabitEdit(editingHabit);
                                        setEditingHabit(null);
                                    }} className="btn-primary bg-gradient-to-r from-orange-500 to-orange-600">Spara</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Settings = ({ theme, setTheme }) => {
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [newPassword, setNewPassword] = useState('');
            const [loading, setLoading] = useState(false);

            const handleChangePassword = async () => {
                if (newPassword.length < 6) {
                    alert("Lösenordet måste vara minst 6 tecken.");
                    return;
                }
                setLoading(true);
                const { error } = await supabase.auth.updateUser({ password: newPassword });
                setLoading(false);
                if (error) alert("Fel: " + error.message);
                else {
                    alert("Lösenordet har uppdaterats!");
                    setNewPassword('');
                    setShowPasswordModal(false);
                }
            };

            const handleLogout = async () => {
                if (confirm("Vill du logga ut?")) {
                    const { error } = await supabase.auth.signOut();
                    if (error) alert("Fel vid utloggning: " + error.message);
                }
            };

            return (
                <div className="p-4 h-full flex flex-col">
                    <div className="mb-6">
                        <h2 className="text-3xl font-bold text-white">Inställningar</h2>
                    </div>
                    
                    <div className="bg-slate-900/50 border border-slate-800 rounded-2xl p-4 mb-4">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-slate-800 rounded-lg text-blue-400">{theme === 'dark' ? <IconMoon /> : <IconSun />}</div>
                                <span className="text-white font-bold text-lg">Utseende</span>
                            </div>
                            <button onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')} className="bg-slate-800 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition-colors border border-slate-700">
                                {theme === 'dark' ? 'Byt till Light Mode' : 'Byt till Dark Mode'}
                            </button>
                        </div>
                    </div>

                    <div className="bg-slate-900/50 border border-slate-800 rounded-2xl p-4 mb-4">
                        <div className="flex items-center gap-3 mb-4">
                            <div className="p-2 bg-slate-800 rounded-lg text-blue-400"><IconLock /></div>
                            <span className="text-white font-bold text-lg">Konto & Säkerhet</span>
                        </div>
                        <button onClick={() => setShowPasswordModal(true)} className="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg transition-colors border border-slate-700 text-left flex justify-between items-center">
                            <span>Byt lösenord</span>
                            <IconChevronRight />
                        </button>
                    </div>

                    <div className="mt-auto">
                        <button onClick={handleLogout} className="w-full flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white font-bold py-3 px-4 rounded-lg transition-colors border border-slate-700">
                            <IconLogOut /> Logga ut
                        </button>
                    </div>

                    {showPasswordModal && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in" onClick={() => setShowPasswordModal(false)}>
                            <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl animate-scale-in" onClick={e => e.stopPropagation()}>
                                <h3 className="text-2xl font-bold mb-4 text-white">Byt lösenord</h3>
                                <input 
                                    type="password" 
                                    className="input-field !mb-4" 
                                    placeholder="Nytt lösenord (min 6 tecken)" 
                                    value={newPassword} 
                                    onChange={e => setNewPassword(e.target.value)}
                                />
                                <div className="flex gap-2">
                                    <button onClick={() => setShowPasswordModal(false)} className="btn-secondary">Avbryt</button>
                                    <button onClick={handleChangePassword} disabled={loading} className="btn-primary bg-gradient-to-r from-blue-600 to-blue-500">
                                        {loading ? 'Sparar...' : 'Spara nytt lösenord'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const Auth = () => {
            const [loading, setLoading] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLogin, setIsLogin] = useState(true);
            const [isReset, setIsReset] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');
            const [successMsg, setSuccessMsg] = useState('');

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setErrorMsg('');
                setSuccessMsg('');
                
                if (isLogin) {
                    const { error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) setErrorMsg(error.message);
                } else {
                    const { error } = await supabase.auth.signUp({ email, password });
                    if (error) setErrorMsg(error.message);
                    else setSuccessMsg("Kolla din mail för att bekräfta kontot!");
                }
                setLoading(false);
            };

            const handleResetPassword = async (e) => {
                e.preventDefault();
                setLoading(true);
                setErrorMsg('');
                setSuccessMsg('');

                const { error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.href,
                });

                if (error) setErrorMsg(error.message);
                else setSuccessMsg("Återställningslänk skickad till din e-post!");
                setLoading(false);
            };

            return (
                <div className="flex flex-col h-screen max-w-md mx-auto bg-slate-950 shadow-2xl border-x border-slate-900 relative overflow-hidden">
                    {/* Background decoration */}
                    <div className="absolute top-[-20%] left-[-20%] w-[140%] h-[60%] bg-blue-600/10 blur-[100px] rounded-full pointer-events-none"></div>
                    <div className="absolute bottom-[-10%] right-[-10%] w-[80%] h-[40%] bg-purple-600/10 blur-[80px] rounded-full pointer-events-none"></div>

                    <div className="flex-1 flex flex-col justify-center p-8 z-10">
                        <div className="text-center mb-12 animate-scale-in">
                            <div className="inline-block p-4 rounded-full bg-slate-900/50 border border-slate-800 mb-4 shadow-lg shadow-blue-900/20">
                                <h1 className="font-bold text-3xl tracking-tight text-blue-400 animate-logo-glow">M-<span className="text-white">CERE</span></h1>
                            </div>
                            <h2 className="text-2xl font-bold text-white mb-2">{isReset ? 'Återställ lösenord' : (isLogin ? 'Välkommen tillbaka' : 'Skapa konto')}</h2>
                            <p className="text-slate-400 text-sm">{isReset ? 'Ange din e-post för att få en återställningslänk' : (isLogin ? 'Logga in för att fortsätta din resa' : 'Börja din resa mot bättre fokus')}</p>
                        </div>

                        <form onSubmit={isReset ? handleResetPassword : handleAuth} className="space-y-4 animate-fade-in" style={{animationDelay: '0.1s'}}>
                            <div className="space-y-4">
                                <div className="relative group">
                                    <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 group-focus-within:text-blue-400 transition-colors">
                                        <IconMail />
                                    </div>
                                    <input 
                                        type="email" 
                                        placeholder="E-postadress" 
                                        className="w-full bg-slate-900/50 border border-slate-800 rounded-xl py-4 pl-12 pr-4 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500 focus:bg-slate-900 transition-all"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        required
                                    />
                                </div>
                                {!isReset && (
                                    <div className="relative group">
                                        <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 group-focus-within:text-blue-400 transition-colors">
                                            <IconLock />
                                        </div>
                                        <input 
                                            type="password" 
                                            placeholder="Lösenord" 
                                            className="w-full bg-slate-900/50 border border-slate-800 rounded-xl py-4 pl-12 pr-4 text-white placeholder-slate-500 focus:outline-none focus:border-blue-500 focus:bg-slate-900 transition-all"
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            required
                                            minLength={6}
                                        />
                                    </div>
                                )}
                            </div>

                            {isLogin && !isReset && (
                                <div className="text-right">
                                    <button 
                                        type="button"
                                        onClick={() => { setIsReset(true); setErrorMsg(''); setSuccessMsg(''); }}
                                        className="text-xs text-slate-400 hover:text-blue-400 transition-colors"
                                    >
                                        Glömt lösenordet?
                                    </button>
                                </div>
                            )}

                            {errorMsg && (
                                <div className="p-3 bg-red-900/20 border border-red-500/30 rounded-lg text-red-400 text-sm text-center animate-fade-in">
                                    {errorMsg}
                                </div>
                            )}
                            
                            {successMsg && (
                                <div className="p-3 bg-green-900/20 border border-green-500/30 rounded-lg text-green-400 text-sm text-center animate-fade-in">
                                    {successMsg}
                                </div>
                            )}

                            <button disabled={loading} className="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-900/20 transition-all active:scale-[0.98] mt-2">
                                {loading ? (
                                    <span className="flex items-center justify-center gap-2">
                                        <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        Bearbetar...
                                    </span>
                                ) : (isReset ? 'Skicka länk' : (isLogin ? 'Logga in' : 'Skapa konto'))}
                            </button>
                        </form>

                        <div className="mt-8 text-center animate-fade-in" style={{animationDelay: '0.2s'}}>
                            {isReset ? (
                                <button 
                                    onClick={() => { setIsReset(false); setIsLogin(true); setErrorMsg(''); setSuccessMsg(''); }} 
                                    className="text-slate-400 hover:text-white text-sm transition-colors"
                                >
                                    Tillbaka till inloggning
                                </button>
                            ) : (
                                <>
                                    <p className="text-slate-500 text-sm mb-3">{isLogin ? 'Har du inget konto?' : 'Har du redan ett konto?'}</p>
                                    <button 
                                        onClick={() => { setIsLogin(!isLogin); setErrorMsg(''); setSuccessMsg(''); }} 
                                        className="text-blue-400 hover:text-blue-300 font-bold text-sm transition-colors border-b border-transparent hover:border-blue-400 pb-0.5"
                                    >
                                        {isLogin ? 'Registrera dig nu' : 'Logga in här'}
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [timerData, setTimerData] = useState({ goal: '', challenges: '', motivation: 50, durationMinutes: 25 });
            const [theme, setTheme] = useState(localStorage.getItem('theme') || 'dark');
            const [session, setSession] = useState(null);
            const [loading, setLoading] = useState(true);

            // Data states
            const [logs, setLogs] = useState([]);
            const [todos, setTodos] = useState([]);
            const [habits, setHabits] = useState([]);
            const [impulses, setImpulses] = useState([]);

            useEffect(() => {
                document.body.className = theme === 'light' ? 'light-mode' : '';
                localStorage.setItem('theme', theme);
            }, [theme]);

            // --- Auth Listener ---
            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    if (!session) setLoading(false);
                });

                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                    if (!session) setLoading(false);
                });

                return () => subscription.unsubscribe();
            }, []);

            // --- Data Fetching ---
            useEffect(() => {
                if (session) {
                    const fetchData = async () => {
                        setLoading(true);
                        const [logsRes, todosRes, habitsRes, impulsesRes, profileRes] = await Promise.all([
                            supabase.from('logs').select('*').order('created_at', { ascending: false }),
                            supabase.from('todos').select('*'),
                            supabase.from('habits').select('*'),
                            supabase.from('impulses').select('*'),
                            supabase.from('profiles').select('theme').eq('id', session.user.id).single()
                        ]);

                        if (logsRes.data) setLogs(logsRes.data);
                        if (todosRes.data) setTodos(todosRes.data);
                        if (habitsRes.data) setHabits(habitsRes.data);
                        if (impulsesRes.data) setImpulses(impulsesRes.data);
                        if (profileRes.data && profileRes.data.theme) setTheme(profileRes.data.theme);

                        setLoading(false);
                    };
                    fetchData();
                }
            }, [session]);

            // --- Data Modification Functions ---

            const saveLog = async (logEntry) => {
                const { data, error } = await supabase.from('logs').insert(logEntry).select();
                if (data) setLogs([data[0], ...logs]);
                if (error) console.error("Error saving log:", error);
            };

            const deleteLog = async (logId) => {
                const { error } = await supabase.from('logs').delete().eq('id', logId);
                if (!error) setLogs(logs.filter(l => l.id !== logId));
            };

            const addTodo = async (newTodo) => {
                const { data, error } = await supabase.from('todos').insert({ desc: newTodo.desc, minutes: newTodo.minutes, priority: newTodo.priority, details: newTodo.details }).select();
                if (data) setTodos([...todos, data[0]]);
            };

            const saveTodoEdit = async (editingTodo) => {
                const { data, error } = await supabase.from('todos').update({ desc: editingTodo.desc, minutes: editingTodo.minutes, priority: editingTodo.priority, details: editingTodo.details }).eq('id', editingTodo.id).select();
                if (data) setTodos(todos.map(t => t.id === editingTodo.id ? data[0] : t));
            };

            const deleteTodoById = async (todoId) => {
                const { error } = await supabase.from('todos').delete().eq('id', todoId);
                if (!error) setTodos(todos.filter(t => t.id !== todoId));
            };

            const completeTodo = async (todo) => {
                await saveLog({ type: 'todo_done', data: { desc: todo.desc, minutes: todo.minutes, priority: todo.priority } });
                await deleteTodoById(todo.id);
            };

            const addHabit = async (habitName) => {
                if (!habitName.trim()) return;
                const { data, error } = await supabase.from('habits').insert({ name: habitName }).select();
                if (data) setHabits([...habits, data[0]]);
            };

            const saveHabitEdit = async (editingHabit) => {
                const { data, error } = await supabase.from('habits').update({ name: editingHabit.name }).eq('id', editingHabit.id).select();
                if (data) setHabits(habits.map(h => h.id === editingHabit.id ? data[0] : h));
            };

            const deleteHabit = async (habitId) => {
                const { error } = await supabase.from('habits').delete().eq('id', habitId);
                if (!error) setHabits(habits.filter(h => h.id !== habitId));
            };

            const toggleHabit = async (habitId) => {
                const todayStr = new Date().toISOString().split('T')[0];
                const logIndex = logs.findIndex(l => l.type === 'habit_done' && l.created_at.startsWith(todayStr) && l.data.habitId === habitId);

                if (logIndex > -1) { // It exists, so delete it
                    await deleteLog(logs[logIndex].id);
                } else { // It doesn't exist, so add it
                    const habit = habits.find(h => h.id === habitId);
                    await saveLog({ type: 'habit_done', data: { habitId: habit.id, name: habit.name } });
                }
            };

            const addImpulse = async (newImpulse) => {
                if(!newImpulse.desc || !newImpulse.estTime) return;
                const estMinutes = parseInt(newImpulse.estTime);
                let waitMinutes = (estMinutes < 20) ? 30 : estMinutes * 3;
                const unlock_time = new Date(Date.now() + waitMinutes * 60 * 1000).toISOString();

                const { data, error } = await supabase.from('impulses').insert({ desc: newImpulse.desc, est_time: estMinutes, unlock_time }).select();
                if (data) setImpulses([...impulses, data[0]]);
            };

            const completeImpulse = async (impulse, action) => {
                await saveLog({ type: action === 'done' ? 'impulse_done' : 'impulse_forgotten', data: { desc: impulse.desc } });
                const { error } = await supabase.from('impulses').delete().eq('id', impulse.id);
                if (!error) setImpulses(impulses.filter(i => i.id !== impulse.id));
            };

            const updateTheme = async (newTheme) => {
                setTheme(newTheme);
                await supabase.from('profiles').update({ theme: newTheme }).eq('id', session.user.id);
            };

            const startTodo = (todo) => {
                setTimerData(prev => ({ ...prev, goal: todo.desc, durationMinutes: todo.minutes, originTodoId: todo.id }));
                setActiveTab('timer');
            };

            if (!session) {
                return <Auth />;
            }

            if (loading) {
                return <div className="flex items-center justify-center h-screen bg-slate-950 text-white">Laddar data...</div>;
            }

            return (
                <div className="flex flex-col h-screen max-w-md mx-auto bg-slate-950 shadow-2xl border-x border-slate-900">
                    <div className="p-4 flex items-center justify-center">
                        <h1 className="font-bold text-lg tracking-tight text-blue-400 animate-logo-glow">M-<span className="text-white">CERE</span></h1>
                    </div>
                    <div className="flex-1 overflow-hidden relative">
                        <div className={activeTab === 'timer' ? 'h-full' : 'hidden'}>
                            <ActivityTimer data={timerData} setData={setTimerData} saveLog={saveLog} deleteTodoById={deleteTodoById} />
                        </div>
                        {activeTab === 'impulse' && <ImpulseControl logs={logs} impulses={impulses} addImpulse={addImpulse} completeImpulse={completeImpulse} />}
                        {activeTab === 'todo' && <TodoList todos={todos} onStartTodo={startTodo} addTodo={addTodo} completeTodo={completeTodo} deleteTodo={deleteTodoById} saveTodoEdit={saveTodoEdit} />}
                        {activeTab === 'habits' && <HabitTracker habits={habits} logs={logs} addHabit={addHabit} toggleHabit={toggleHabit} saveHabitEdit={saveHabitEdit} deleteHabit={deleteHabit} />}
                        {activeTab === 'home' && <Dashboard onOpenSettings={() => setActiveTab('settings')} logs={logs} habits={habits} deleteLog={deleteLog} />}
                        {activeTab === 'settings' && <Settings theme={theme} setTheme={updateTheme} />}
                    </div>
                    <div className="h-16 bg-slate-900 border-t border-slate-800 flex justify-around items-center">
                        <NavButton active={activeTab === 'timer'} onClick={() => setActiveTab('timer')} icon={<IconTimer />} label="Fokus" />
                        <NavButton active={activeTab === 'todo'} onClick={() => setActiveTab('todo')} icon={<IconCheck />} label="To-do" />
                        <NavButton active={activeTab === 'home'} onClick={() => setActiveTab('home')} icon={<IconHome />} label="Start" />
                        <NavButton active={activeTab === 'impulse'} onClick={() => setActiveTab('impulse')} icon={<IconZap />} label="Impuls" />
                        <NavButton active={activeTab === 'habits'} onClick={() => setActiveTab('habits')} icon={<IconGrid />} label="Vanor" />
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>