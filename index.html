<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impuls & Fokus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { background-color: #000000; color: #6ca1e1; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .input-field { @apply w-full bg-slate-700 border border-slate-600 rounded-lg py-4 px-8 mb-6 text-lg text-white focus:outline-none focus:border-blue-500 transition-all; }
        .btn-primary { @apply w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl transition-colors active:scale-95; }
        .btn-secondary { @apply w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded transition-colors active:scale-95; }
        .card { @apply bg-slate-900 border border-slate-800 rounded-lg p-4 shadow-lg mb-4; }
        
        @keyframes pulse-red {
            0%, 100% { background-color: #7f1d1d; }
            50% { background-color: #991b1b; }
        }
        .animate-alarm { animation: pulse-red 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in { animation: fade-in 0.2s ease-out; }

        @keyframes scale-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-scale-in { animation: scale-in 0.2s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- INLINE ICONS ---
        const IconTimer = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
        const IconZap = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>;
        const IconList = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>;
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>;
        const IconBell = () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
        const IconPlay = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>;
        const IconGrid = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>;
        const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const IconHome = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>;
        const IconCalendar = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>;
        const IconChevronLeft = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>;
        const IconChevronRight = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>;

        // --- AUDIO HELPER (Syntetiskt ljud, inga filer behövs) ---
        const playBeep = () => {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'square';
                osc.frequency.setValueAtTime(440, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
                osc.start();
                osc.stop(ctx.currentTime + 0.5);
            } catch (e) { console.error("Audio error", e); }
        };

        const NavButton = ({ active, icon, label, onClick }) => (
            <button 
                onClick={onClick}
                className={`flex flex-col items-center justify-center p-2 flex-1 transition-colors ${active ? 'text-blue-400' : 'text-slate-500 hover:text-slate-300'}`}
            >
                {icon}
                <span className="text-xs mt-1">{label}</span>
            </button>
        );

        // 1. Aktivitetstimer (Uppdaterad med Nedräkning & Alarm)
        const ActivityTimer = ({ data, setData }) => {
            const [state, setState] = useState('setup'); // setup, running, alarm, review
            const [remaining, setRemaining] = useState(0);
            const [initialDuration, setInitialDuration] = useState(0); // Sparar totaltiden för loggen
            const [review, setReview] = useState({ success: true, satisfaction: 50 });
            const [sessionBehaviors, setSessionBehaviors] = useState([]);
            
            // Timer logic
            useEffect(() => {
                let interval;
                if (state === 'running') {
                    interval = setInterval(() => {
                        setRemaining(prev => {
                            if (prev <= 1) {
                                clearInterval(interval);
                                setState('alarm');
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [state]);

            // Alarm Sound Loop
            useEffect(() => {
                let soundInterval;
                if (state === 'alarm') {
                    playBeep(); // Spela direkt
                    soundInterval = setInterval(playBeep, 1500); // Repetera var 1.5s
                }
                return () => clearInterval(soundInterval);
            }, [state]);

            const startSession = () => {
                const totalSeconds = parseInt(data.durationMinutes) * 60;
                setRemaining(totalSeconds);
                setInitialDuration(totalSeconds);
                setSessionBehaviors([]);
                setState('running');
            };

            const stopAlarm = () => {
                setState('review');
            };

            const cancelSession = () => {
                if(confirm("Vill du avbryta passet?")) {
                    setSessionBehaviors([]);
                    setState('setup');
                }
            }

            const saveSession = () => {
                const sessionLog = {
                    type: 'activity',
                    timestamp: new Date().toISOString(),
                    durationSeconds: initialDuration,
                    completed: true,
                    ...data,
                    ...review,
                    behaviors: sessionBehaviors
                };
                saveToLog(sessionLog);
                setState('setup');
                setData({ goal: '', challenges: '', motivation: 50, durationMinutes: 25 });
                setSessionBehaviors([]);
                alert("Pass sparat!");
            };

            const formatTime = (s) => {
                const min = Math.floor(s / 60);
                const sec = s % 60;
                return `${min}:${sec < 10 ? '0' : ''}${sec}`;
            };

            // --- Vyer ---

            const isInvalid = !data.goal;

            if (state === 'setup') return (
                <div className="p-4 h-full flex flex-col">
                    <div className="mb-6">
                        <h2 className="text-3xl font-bold text-white">Fokus</h2>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto space-y-4 pb-4">
                        {/* Duration */}
                        <div className="bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
                            <div className="flex justify-between items-center mb-3">
                                <label className="text-slate-400 text-xs uppercase font-bold tracking-wider">Tidslängd</label>
                                <span className="text-white font-bold">{data.durationMinutes} min</span>
                            </div>
                            <div className="grid grid-cols-4 gap-2">
                                {[15, 25, 45, 60].map(m => (
                                    <button key={m} onClick={() => setData({...data, durationMinutes: m})} className={`py-2 rounded-lg text-sm font-bold transition-all ${data.durationMinutes == m ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50 scale-105' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>{m}</button>
                                ))}
                            </div>
                            <input type="range" min="5" max="120" step="5" value={data.durationMinutes} onChange={e => setData({...data, durationMinutes: e.target.value})} className="w-full mt-4 accent-blue-500 h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
                        </div>

                        {/* Goal */}
                        <div className="bg-gradient-to-br from-blue-500/10 to-blue-600/5 border border-blue-500/20 p-4 rounded-2xl relative overflow-hidden group focus-within:border-blue-500/50 transition-colors">
                            <div className="absolute top-0 right-0 p-2 opacity-10 pointer-events-none"><IconTimer /></div>
                            <label className="block text-blue-400 text-xs uppercase font-bold tracking-wider mb-2">Vad är målet?</label>
                            <textarea rows="2" className="w-full bg-transparent text-xl font-bold text-white placeholder-blue-500/30 focus:outline-none resize-none" placeholder="Skriv ditt mål här..." value={data.goal} onChange={e => setData({...data, goal: e.target.value})} />
                        </div>

                        {/* Challenges */}
                        <div className="bg-slate-900/50 border border-slate-800 rounded-2xl p-4 focus-within:border-slate-600 transition-colors">
                            <label className="block text-slate-400 text-xs uppercase font-bold tracking-wider mb-2">Utmaningar?</label>
                            <input className="w-full bg-transparent text-white placeholder-slate-600 focus:outline-none" placeholder="T.ex. distraktioner..." value={data.challenges} onChange={e => setData({...data, challenges: e.target.value})} />
                        </div>

                        {/* Motivation */}
                        <div className="bg-slate-900/50 border border-slate-800 rounded-2xl p-4">
                            <div className="flex items-center justify-between mb-2">
                                <label className="text-slate-400 text-xs uppercase font-bold tracking-wider">Motivation</label>
                                <span className={`font-bold ${data.motivation > 80 ? 'text-green-400' : data.motivation > 50 ? 'text-blue-400' : 'text-slate-400'}`}>{data.motivation}%</span>
                            </div>
                            <input type="range" min="0" max="100" value={data.motivation} onChange={e => setData({...data, motivation: parseInt(e.target.value)})} className="w-full accent-blue-500 h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer" />
                        </div>
                    </div>

                    <div className="mt-2">
                        <button disabled={isInvalid} className={`w-full block font-bold text-xl py-4 rounded-2xl transition-all duration-500 shadow-xl ${isInvalid ? 'bg-slate-800 text-slate-600 cursor-not-allowed' : 'bg-gradient-to-r from-orange-500 to-orange-600 text-white hover:scale-[1.02] active:scale-[0.98] shadow-orange-900/20'}`} onClick={startSession}>Starta timer</button>
                    </div>
                </div>
            );

            if (state === 'running') {
                const progress = ((initialDuration - remaining) / initialDuration) * 100;
                return (
                    <div className="flex flex-col h-full p-4 relative pt-6">
                        {/* Progress bar background */}
                        <div className="absolute top-0 left-0 h-2 bg-slate-800 w-full">
                            <div className="h-full bg-green-500 transition-all duration-1000" style={{width: `${progress}%`}}></div>
                        </div>

                        <div className="flex-1 flex flex-col items-center justify-center">
                            <div className="text-7xl font-mono font-bold text-green-400 mb-8 tracking-tighter">{formatTime(remaining)}</div>
                            <div className="text-center mb-8 space-y-2 max-w-xs">
                                <p className={`text-white font-bold ${data.challenges ? 'text-lg' : 'text-2xl'}`}>{data.goal}</p>
                                {data.challenges && <p className="text-slate-400 text-sm">Utmaning: {data.challenges}</p>}
                            </div>
                        </div>
                        
                        <button className="text-slate-500 hover:text-white underline text-sm mt-4 text-center" onClick={cancelSession}>Avbryt pass</button>
                    </div>
                );
            }

            if (state === 'alarm') return (
                <div className="flex flex-col items-center justify-center h-full p-4 animate-alarm bg-red-900">
                    <IconBell />
                    <h1 className="text-4xl font-bold text-white mt-4 mb-8">Tiden är ute!</h1>
                    <p className="text-white/80 mb-8 text-center">{data.goal}</p>
                    <button className="w-full bg-transparent text-white text-xl font-bold py-6 hover:text-slate-200 transition-colors active:scale-95" onClick={stopAlarm}>
                        Stäng av och utvärdera
                    </button>
                </div>
            );

            if (state === 'review') return (
                <div className="p-4 space-y-4 text-center">
                    <h2 className="text-xl font-bold">Bra jobbat!</h2>
                    <p className="text-slate-400">Du fokuserade i {data.durationMinutes} minuter.</p>
                    <div className="space-y-2">
                        <p>Uppnådde du målet?</p>
                        <div className="flex gap-2">
                            <button onClick={() => setReview({...review, success: true})} className={`flex-1 p-3 rounded border ${review.success ? 'bg-green-900/30 border-green-500 text-green-400' : 'border-slate-700'}`}>Ja</button>
                            <button onClick={() => setReview({...review, success: false})} className={`flex-1 p-3 rounded border ${!review.success ? 'bg-red-900/30 border-red-500 text-red-400' : 'border-slate-700'}`}>Nej</button>
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm text-slate-400 mb-1">Nöjdhet (0-100)</label>
                        <div className="flex items-center gap-4">
                            <input type="range" min="0" max="100" value={review.satisfaction} onChange={e => setReview({...review, satisfaction: parseInt(e.target.value)})} className="w-full accent-blue-500" />
                            <span className="font-bold w-8">{review.satisfaction}</span>
                        </div>
                    </div>
                    <button className="btn-primary" onClick={saveSession}>Spara till Logg</button>
                    <button className="text-slate-400 hover:text-white text-sm mt-4 underline block w-full" onClick={() => {
                        setState('setup');
                        setData({ goal: '', challenges: '', motivation: 50, durationMinutes: 25 });
                        setSessionBehaviors([]);
                    }}>Spara inte</button>
                </div>
            );
        };

        // 2. Impulskontroll (Oförändrad logik, bara inlistad för kompletthet)
        const ImpulseControl = () => {
            const [impulses, setImpulses] = useState([]);
            const [newImpulse, setNewImpulse] = useState({ desc: '', estTime: '' });
            const [now, setNow] = useState(Date.now());
            const [stats, setStats] = useState({ done: 0, forgotten: 0 });
            const [isAdding, setIsAdding] = useState(false);

            useEffect(() => {
                const interval = setInterval(() => setNow(Date.now()), 1000);
                const saved = localStorage.getItem('impulses');
                if(saved) setImpulses(JSON.parse(saved));
                updateStats();
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                localStorage.setItem('impulses', JSON.stringify(impulses));
            }, [impulses]);

            const updateStats = () => {
                const logs = JSON.parse(localStorage.getItem('logs') || '[]');
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;
                const recent = logs.filter(l => (now - new Date(l.timestamp).getTime()) < oneDay);
                setStats({
                    done: recent.filter(l => l.type === 'impulse_done').length,
                    forgotten: recent.filter(l => l.type === 'impulse_forgotten').length
                });
            };

            const addImpulse = () => {
                if(!newImpulse.desc || !newImpulse.estTime) return;
                const estMinutes = parseInt(newImpulse.estTime);
                let waitMinutes = 0;
                if (estMinutes < 20) waitMinutes = 30; 
                else waitMinutes = estMinutes * 3;

                const unlockTime = Date.now() + (waitMinutes * 60 * 1000);
                setImpulses([{id: Date.now(), desc: newImpulse.desc, estTime: estMinutes, unlockTime}, ...impulses]);
                setNewImpulse({ desc: '', estTime: '' });
                setIsAdding(false);
            };

            const completeImpulse = (id, action) => {
                const updated = impulses.filter(i => i.id !== id);
                setImpulses(updated);
                saveToLog({ type: action === 'done' ? 'impulse_done' : 'impulse_forgotten', timestamp: new Date().toISOString(), impulseId: id });
                updateStats();
            };

            const formatCountdown = (unlockTime) => {
                const diff = unlockTime - now;
                if (diff <= 0) return "REDO";
                const h = Math.floor(diff / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                return `${h}h ${m}m ${s}s`;
            };

            const isInvalid = !newImpulse.desc || !newImpulse.estTime;

            return (
                <div className="p-4 h-full flex flex-col relative">
                    <div className="mb-6">
                        <h2 className="text-3xl font-bold text-white">Impulser</h2>
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-6">
                        <div className="bg-slate-900/50 border border-slate-800 p-3 rounded-xl">
                            <div className="text-green-400 text-xs font-bold uppercase tracking-wider mb-1">Gjorda</div>
                            <div className="text-2xl font-bold text-white">{stats.done}</div>
                        </div>
                        <div className="bg-slate-900/50 border border-slate-800 p-3 rounded-xl">
                            <div className="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Glömda</div>
                            <div className="text-2xl font-bold text-white">{stats.forgotten}</div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto space-y-3 pb-20">
                        {impulses.length === 0 && <p className="text-center text-slate-500 mt-10 text-sm">Inga aktiva impulser.</p>}
                        {impulses.map(imp => {
                            const isReady = imp.unlockTime <= now;
                            return (
                                <div key={imp.id} className={`bg-slate-900/50 border rounded-2xl p-4 transition-all ${isReady ? 'border-green-500/50 shadow-[0_0_15px_rgba(34,197,94,0.1)]' : 'border-slate-800'}`}>
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h3 className="font-bold text-lg text-white">{imp.desc}</h3>
                                            <p className="text-slate-400 text-xs mt-1">Väntetid: {imp.estTime} min</p>
                                        </div>
                                        {isReady ? (
                                            <div className="flex flex-col gap-2">
                                                <button onClick={() => completeImpulse(imp.id, 'done')} className="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded-lg text-sm font-bold transition-colors">Gör</button>
                                                <button onClick={() => completeImpulse(imp.id, 'forgotten')} className="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded-lg text-sm font-bold transition-colors">Glöm</button>
                                            </div>
                                        ) : <span className="font-mono text-yellow-500 font-bold text-sm bg-yellow-500/10 px-2 py-1 rounded">{formatCountdown(imp.unlockTime)}</span>}
                                    </div>
                                </div>
                            )
                        })}
                    </div>

                    <button 
                        onClick={() => setIsAdding(true)}
                        className="absolute bottom-6 right-6 w-14 h-14 bg-blue-600 hover:bg-blue-500 rounded-full flex items-center justify-center shadow-lg text-white transition-transform active:scale-90 z-10"
                    >
                        <IconPlus />
                    </button>

                    {isAdding && (
                        <div className="fixed inset-0 bg-slate-950/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in" onClick={() => setIsAdding(false)}>
                            <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl animate-scale-in text-center" onClick={e => e.stopPropagation()}>
                                <h3 className="text-2xl font-bold mb-6 text-white">Registrera Impuls</h3>
                                <input className="input-field text-center !py-3 !mb-3" placeholder="Vad vill du göra?" autoFocus value={newImpulse.desc} onChange={e => setNewImpulse({...newImpulse, desc: e.target.value})} />
                                <input type="number" className="input-field text-center !py-3 !mb-3" placeholder="Tid (min)?" value={newImpulse.estTime} onChange={e => setNewImpulse({...newImpulse, estTime: e.target.value})} />
                                <div className="flex gap-2 mt-4">
                                    <button onClick={() => setIsAdding(false)} className="btn-secondary">Avbryt</button>
                                    <button disabled={isInvalid} className={`w-full font-bold text-lg py-3 rounded-xl transition-colors ${isInvalid ? 'bg-slate-800 text-slate-600 cursor-not-allowed' : 'bg-gradient-to-r from-orange-500 to-orange-600 text-white'}`} onClick={addImpulse}>Lås in</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 3. Dashboard (Start/Huvudfönster)
        const Dashboard = () => {
            const [logs, setLogs] = useState([]);
            const [selectedLog, setSelectedLog] = useState(null);
            const [timeRange, setTimeRange] = useState('24h');
            const [statsView, setStatsView] = useState(null);

            const getGreeting = () => {
                const h = new Date().getHours();
                if (h >= 5 && h < 12) return "God morgon";
                if (h >= 12 && h < 18) return "God eftermiddag";
                return "God kväll";
            };

            const getBackgroundGradient = () => {
                const h = new Date().getHours();
                if (h >= 5 && h < 12) return "bg-gradient-to-b from-sky-950/40 to-slate-950";
                if (h >= 12 && h < 18) return "bg-gradient-to-b from-blue-950/40 to-slate-950";
                return "bg-gradient-to-b from-indigo-950/40 to-slate-950";
            };

            useEffect(() => {
                const saved = localStorage.getItem('logs');
                if(saved) setLogs(JSON.parse(saved));
            }, []);

            const deleteLog = (timestamp) => {
                const updated = logs.filter(l => l.timestamp !== timestamp);
                setLogs(updated);
                localStorage.setItem('logs', JSON.stringify(updated));
            };

            // Statistik-beräkning
            const now = new Date();
            const timeWindow = timeRange === '24h' ? 24 * 60 * 60 * 1000 : 7 * 24 * 60 * 60 * 1000;
            const recentActivity = logs.filter(l => l.type === 'activity' && (now - new Date(l.timestamp).getTime()) < timeWindow);
            const totalMinutes = Math.round(recentActivity.reduce((acc, curr) => acc + (curr.durationSeconds / 60), 0));
            
            const recentTodos = logs.filter(l => l.type === 'todo_done' && (now - new Date(l.timestamp).getTime()) < timeWindow);
            const totalTodos = recentTodos.length;
            
            const hoursDistribution = new Array(24).fill(0);
            recentActivity.forEach(l => {
                const h = new Date(l.timestamp).getHours();
                hoursDistribution[h] += (l.durationSeconds / 60);
            });
            const maxVal = Math.max(...hoursDistribution, 1);

            // Cirkeldiagram-data
            const behaviorCounts = {};
            recentActivity.forEach(l => {
                if (l.behaviors) {
                    l.behaviors.forEach(b => {
                        behaviorCounts[b.behavior] = (behaviorCounts[b.behavior] || 0) + 1;
                    });
                }
            });
            const totalBehaviors = Object.values(behaviorCounts).reduce((a, b) => a + b, 0);
            let currentAngle = 0;
            const colors = ['#60a5fa', '#34d399', '#f87171', '#fbbf24', '#a78bfa', '#e879f9'];
            const pieSegments = Object.entries(behaviorCounts).sort((a,b) => b[1] - a[1]).map(([name, count], index) => {
                const angle = (count / totalBehaviors) * 360;
                const color = colors[index % colors.length];
                const style = `${color} ${currentAngle}deg ${currentAngle + angle}deg`;
                currentAngle += angle;
                return { name, percentage: Math.round((count/totalBehaviors)*100), color, style };
            });
            const pieGradient = `conic-gradient(${pieSegments.map(s => s.style).join(', ')})`;

            return (
                <div className={`p-4 h-full flex flex-col ${getBackgroundGradient()}`}>
                    <div className="flex items-center justify-between mb-6">
                        <div>
                            <h2 className="text-3xl font-bold text-white">{getGreeting()}</h2>
                            <p className="text-slate-400 text-sm capitalize">{new Date().toLocaleDateString('sv-SE', { weekday: 'long', day: 'numeric', month: 'long' })}</p>
                        </div>
                        <div className="flex bg-slate-800 p-1 rounded-lg border border-slate-700">
                            <button onClick={() => setTimeRange('24h')} className={`px-3 py-1 rounded text-xs font-bold transition-colors ${timeRange === '24h' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>24h</button>
                            <button onClick={() => setTimeRange('7d')} className={`px-3 py-1 rounded text-xs font-bold transition-colors ${timeRange === '7d' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>7d</button>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-6">
                        <div onClick={() => setStatsView('focus')} className="bg-gradient-to-br from-blue-500/10 to-blue-600/5 border border-blue-500/20 p-4 rounded-2xl relative overflow-hidden cursor-pointer hover:border-blue-500/40 transition-all active:scale-95">
                            <div className="absolute top-0 right-0 p-2 opacity-10"><IconTimer /></div>
                            <div className="text-blue-400 text-xs font-bold uppercase tracking-wider mb-1">Fokus</div>
                            <div className="text-3xl font-bold text-white">{totalMinutes}<span className="text-sm font-normal text-blue-200/50 ml-1">min</span></div>
                        </div>
                        <div onClick={() => setStatsView('todo')} className="bg-gradient-to-br from-green-500/10 to-green-600/5 border border-green-500/20 p-4 rounded-2xl relative overflow-hidden cursor-pointer hover:border-green-500/40 transition-all active:scale-95">
                            <div className="absolute top-0 right-0 p-2 opacity-10"><IconCheck /></div>
                            <div className="text-green-400 text-xs font-bold uppercase tracking-wider mb-1">Uppgifter</div>
                            <div className="text-3xl font-bold text-white">{totalTodos}<span className="text-sm font-normal text-green-200/50 ml-1">st</span></div>
                        </div>
                    </div>

                    <div className="bg-slate-900/50 border border-slate-800 rounded-2xl p-4 mb-6">
                        <div className="flex items-end justify-between h-16 gap-1">
                            {hoursDistribution.map((mins, i) => (
                                <div key={i} className="flex-1 flex flex-col justify-end group relative h-full">
                                    <div className={`w-full rounded-t-sm transition-all ${mins > 0 ? 'bg-blue-500' : 'bg-slate-800'}`} style={{height: `${(mins / maxVal) * 100}%`, minHeight: '2px'}}></div>
                                </div>
                            ))}
                        </div>
                        <div className="flex justify-between text-[10px] text-slate-500 mt-2 px-1 font-mono"><span>00:00</span><span>12:00</span><span>23:59</span></div>
                    </div>

                    {totalBehaviors > 0 && (
                        <div className="bg-slate-900/50 border border-slate-800 rounded-2xl p-4 mb-6 flex items-center gap-6">
                            <div className="w-20 h-20 rounded-full flex-shrink-0 shadow-lg" style={{ background: pieGradient }}></div>
                            <div className="flex-1 space-y-1">
                                {pieSegments.slice(0, 3).map(s => (
                                    <div key={s.name} className="flex items-center justify-between text-xs">
                                        <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full" style={{backgroundColor: s.color}}></div><span className="text-slate-300 truncate max-w-[80px]">{s.name}</span></div>
                                        <span className="font-bold text-white">{s.percentage}%</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    <div className="flex-1 overflow-hidden flex flex-col">
                        <h3 className="text-slate-400 text-xs uppercase font-bold mb-3 tracking-wider text-left">Senaste händelser</h3>
                        <div className="flex-1 overflow-y-auto space-y-2 pr-1">
                            {logs.slice().reverse().filter(l => l.type === 'activity' || l.type === 'todo_done').slice(0, 20).map((l) => (
                                <div key={l.timestamp} onClick={() => setSelectedLog(l)} className="group flex items-center justify-between text-sm bg-slate-900/50 border border-slate-800 p-3 rounded-xl cursor-pointer hover:bg-slate-800 transition-colors">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-2 h-2 rounded-full ${l.type === 'activity' ? 'bg-blue-500' : 'bg-green-500'}`}></div>
                                        <span className="text-white font-medium truncate max-w-[150px]">
                                            {l.type === 'activity' ? l.goal : l.desc}
                                        </span>
                                    </div>
                                    <span className="text-slate-500 text-xs">{new Date(l.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    {selectedLog && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onClick={() => setSelectedLog(null)}>
                            <div className="bg-slate-900 border border-slate-700 p-6 rounded-xl max-w-sm w-full shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="text-xl font-bold mb-4 text-white">Detaljer</h3>
                                {selectedLog.type === 'activity' ? (
                                    <div className="space-y-3 text-left text-sm">
                                        <p><span className="text-slate-400 block text-xs uppercase">Typ</span> Fokuspass</p>
                                        <p><span className="text-slate-400 block text-xs uppercase">Tid</span> {new Date(selectedLog.timestamp).toLocaleString()}</p>
                                        <p><span className="text-slate-400 block text-xs uppercase">Längd</span> {Math.round(selectedLog.durationSeconds / 60)} min</p>
                                        <p><span className="text-slate-400 block text-xs uppercase">Mål</span> {selectedLog.goal}</p>
                                        <p><span className="text-slate-400 block text-xs uppercase">Utmaningar</span> {selectedLog.challenges || '-'}</p>
                                        <p><span className="text-slate-400 block text-xs uppercase">Motivation</span> {selectedLog.motivation}/100</p>
                                        <p><span className="text-slate-400 block text-xs uppercase">Nöjdhet</span> {selectedLog.satisfaction}/100</p>
                                        <p><span className="text-slate-400 block text-xs uppercase">Lyckades?</span> {selectedLog.success ? 'Ja' : 'Nej'}</p>
                                        {selectedLog.behaviors && selectedLog.behaviors.length > 0 && (
                                            <div className="pt-2 mt-2 border-t border-slate-700">
                                                <p><span className="text-slate-400 block text-xs uppercase mb-1">Beteenden</span></p>
                                                <ul className="list-disc pl-4 space-y-1 text-slate-300">
                                                    {selectedLog.behaviors.map((b, i) => <li key={i}>{b.behavior} <span className="text-slate-500 text-xs">({new Date(b.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})})</span></li>)}
                                                </ul>
                                            </div>
                                        )}
                                    </div>
                                ) : selectedLog.type === 'todo_done' ? (
                                    <div className="space-y-3 text-left text-sm">
                                        <p><span className="text-slate-400 block text-xs uppercase">Typ</span> Uppgift klar</p>
                                        <p><span className="text-slate-400 block text-xs uppercase">Uppgift</span> {selectedLog.desc}</p>
                                        <p><span className="text-slate-400 block text-xs uppercase">Tid</span> {new Date(selectedLog.timestamp).toLocaleString()}</p>
                                        <p><span className="text-slate-400 block text-xs uppercase">Estimerad tid</span> {selectedLog.minutes} min</p>
                                    </div>
                                ) : (
                                    <div className="space-y-3 text-left text-sm">
                                        <p><span className="text-slate-400 block text-xs uppercase">Typ</span> Beteende</p>
                                        <p><span className="text-slate-400 block text-xs uppercase">Händelse</span> {selectedLog.behavior}</p>
                                        <p><span className="text-slate-400 block text-xs uppercase">Tid</span> {new Date(selectedLog.timestamp).toLocaleString()}</p>
                                    </div>
                                )}
                                <div className="flex gap-2 mt-6">
                                    <button className="btn-secondary" onClick={() => setSelectedLog(null)}>Stäng</button>
                                    <button className="bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-4 rounded transition-colors active:scale-95 flex-1" onClick={() => {
                                        if(confirm("Ta bort händelse?")) {
                                            deleteLog(selectedLog.timestamp);
                                            setSelectedLog(null);
                                        }
                                    }}>Ta bort</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {statsView && (
                        <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onClick={() => setStatsView(null)}>
                            <div className="bg-slate-900 border border-slate-700 p-6 rounded-xl max-w-sm w-full shadow-2xl" onClick={e => e.stopPropagation()}>
                                {statsView === 'focus' && (() => {
                                    const numSessions = recentActivity.length;
                                    const avgLength = numSessions > 0 ? Math.round(totalMinutes / numSessions) : 0;
                                    const successRate = numSessions > 0 ? Math.round(recentActivity.filter(s => s.success).length / numSessions * 100) : 0;
                                    const avgMotivation = numSessions > 0 ? Math.round(recentActivity.reduce((a,c) => a + c.motivation, 0) / numSessions) : 0;
                                    const avgSatisfaction = numSessions > 0 ? Math.round(recentActivity.reduce((a,c) => a + c.satisfaction, 0) / numSessions) : 0;

                                    return (
                                        <div>
                                            <h3 className="text-xl font-bold mb-4 text-white">Fokusstatistik ({timeRange === '24h' ? '24h' : '7d'})</h3>
                                            <div className="space-y-3 text-sm">
                                                <p className="flex justify-between"><span>Antal pass:</span> <span className="font-bold">{numSessions}</span></p>
                                                <p className="flex justify-between"><span>Total tid:</span> <span className="font-bold">{totalMinutes} min</span></p>
                                                <p className="flex justify-between"><span>Snittlängd:</span> <span className="font-bold">{avgLength} min</span></p>
                                                <p className="flex justify-between"><span>Lyckade pass:</span> <span className="font-bold">{successRate}%</span></p>
                                                <p className="flex justify-between"><span>Snittmotivation:</span> <span className="font-bold">{avgMotivation}/100</span></p>
                                                <p className="flex justify-between"><span>Snittnöjdhet:</span> <span className="font-bold">{avgSatisfaction}/100</span></p>
                                            </div>
                                        </div>
                                    );
                                })()}
                                {statsView === 'todo' && (() => {
                                    const priorityCounts = recentTodos.reduce((acc, todo) => {
                                        acc[todo.priority] = (acc[todo.priority] || 0) + 1;
                                        return acc;
                                    }, { high: 0, medium: 0, low: 0 });
                                    const total = priorityCounts.high + priorityCounts.medium + priorityCounts.low;

                                    return (
                                        <div>
                                            <h3 className="text-xl font-bold mb-4 text-white">Uppgiftsstatistik ({timeRange === '24h' ? '24h' : '7d'})</h3>
                                            <div className="space-y-4 text-sm">
                                                <p className="flex justify-between text-lg"><span>Totalt avklarade:</span> <span className="font-bold">{totalTodos}</span></p>
                                                <div>
                                                    <h4 className="text-slate-400 text-xs uppercase font-bold mb-2">Prioritet</h4>
                                                    <div className="space-y-2">
                                                        <div className="flex items-center"><span className="w-20 text-slate-300">Hög</span><div className="flex-1 bg-slate-800 rounded-full h-4"><div className="bg-red-500 h-4 rounded-full" style={{width: `${total > 0 ? (priorityCounts.high / total) * 100 : 0}%`}}></div></div><span className="w-8 text-right font-bold">{priorityCounts.high}</span></div>
                                                        <div className="flex items-center"><span className="w-20 text-slate-300">Medel</span><div className="flex-1 bg-slate-800 rounded-full h-4"><div className="bg-yellow-500 h-4 rounded-full" style={{width: `${total > 0 ? (priorityCounts.medium / total) * 100 : 0}%`}}></div></div><span className="w-8 text-right font-bold">{priorityCounts.medium}</span></div>
                                                        <div className="flex items-center"><span className="w-20 text-slate-300">Låg</span><div className="flex-1 bg-slate-800 rounded-full h-4"><div className="bg-green-500 h-4 rounded-full" style={{width: `${total > 0 ? (priorityCounts.low / total) * 100 : 0}%`}}></div></div><span className="w-8 text-right font-bold">{priorityCounts.low}</span></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })()}
                                <button className="btn-primary mt-6" onClick={() => setStatsView(null)}>Stäng</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 4. To-do List
        const TodoList = ({ onStartTodo }) => {
            const [todos, setTodos] = useState([]);
            const [newTodo, setNewTodo] = useState({ desc: '', minutes: '', priority: 'medium' });
            const [isAdding, setIsAdding] = useState(false);
            const [editingTodo, setEditingTodo] = useState(null);
            const longPressTimer = useRef(null);

            useEffect(() => {
                const saved = localStorage.getItem('todos');
                if(saved) setTodos(JSON.parse(saved));
            }, []);

            useEffect(() => {
                localStorage.setItem('todos', JSON.stringify(todos));
            }, [todos]);

            const addTodo = () => {
                if (!newTodo.desc || !newTodo.minutes) return;
                
                const newItem = {
                    id: Date.now(),
                    desc: newTodo.desc,
                    minutes: parseInt(newTodo.minutes),
                    priority: newTodo.priority
                };

                const pMap = { 'high': 1, 'medium': 2, 'low': 3 };
                const updated = [...todos, newItem].sort((a, b) => pMap[a.priority] - pMap[b.priority]);

                setTodos(updated);
                setNewTodo({ desc: '', minutes: '', priority: 'medium' });
                setIsAdding(false);
            };

            const handleLongPressStart = (e, todo) => {
                if (e.target.closest('button')) return; // Ignorera om man klickar på knappar
                longPressTimer.current = setTimeout(() => {
                    setEditingTodo(todo);
                }, 500);
            };

            const handleLongPressEnd = () => {
                if (longPressTimer.current) clearTimeout(longPressTimer.current);
            };

            const saveTodoEdit = () => {
                if (!editingTodo.desc || !editingTodo.minutes) return;
                const pMap = { 'high': 1, 'medium': 2, 'low': 3 };
                const updated = todos.map(t => t.id === editingTodo.id ? editingTodo : t).sort((a, b) => pMap[a.priority] - pMap[b.priority]);
                setTodos(updated);
                setEditingTodo(null);
            };

            const completeTodo = (todo) => {
                const updated = todos.filter(t => t.id !== todo.id);
                setTodos(updated);
                saveToLog({
                    type: 'todo_done',
                    desc: todo.desc,
                    minutes: todo.minutes,
                    priority: todo.priority,
                    timestamp: new Date().toISOString()
                });
            };

            const deleteTodo = (id) => {
                const updated = todos.filter(t => t.id !== id);
                setTodos(updated);
            };

            const pColors = { high: 'border-l-red-500 bg-red-900/10', medium: 'border-l-yellow-500 bg-yellow-900/10', low: 'border-l-green-500 bg-green-900/10' };
            const pLabels = { high: 'Hög', medium: 'Medel', low: 'Låg' };

            return (
                <div className="p-4 h-full flex flex-col relative">
                    <div className="mb-6">
                        <h2 className="text-3xl font-bold text-white">Att göra</h2>
                    </div>

                    <div className="flex-1 overflow-y-auto space-y-3 pb-20">
                        {todos.length === 0 && <p className="text-center text-slate-500 mt-10 text-sm">Inget att göra.</p>}
                        {todos.map(t => (
                            <div 
                                key={t.id} 
                                onMouseDown={(e) => handleLongPressStart(e, t)}
                                onMouseUp={handleLongPressEnd}
                                onMouseLeave={handleLongPressEnd}
                                onTouchStart={(e) => handleLongPressStart(e, t)}
                                onTouchEnd={handleLongPressEnd}
                                onTouchMove={handleLongPressEnd}
                                className={`bg-slate-900/50 border-l-4 ${pColors[t.priority]} rounded-r-xl p-4 flex justify-between items-center border-y border-r border-slate-800/50 select-none active:scale-[0.99] transition-transform`}>
                                <div>
                                    <h3 className="font-bold text-lg text-white">{t.desc}</h3>
                                    <div className="flex gap-3 text-xs text-slate-400 mt-1">
                                        <span className="flex items-center gap-1">{t.minutes} min</span>
                                        <span className="uppercase font-bold tracking-wider self-center px-2 py-0.5 rounded bg-slate-800">{pLabels[t.priority]}</span>
                                    </div>
                                </div>
                                <div className="flex items-center">
                                    <button onClick={() => onStartTodo(t)} className="text-slate-400 hover:text-blue-400 p-2 transition-colors" title="Starta"><IconPlay /></button>
                                    <button onClick={() => completeTodo(t)} className="text-slate-400 hover:text-green-400 p-2 transition-colors" title="Klar"><IconCheck /></button>
                                    <button onClick={() => deleteTodo(t.id)} className="text-slate-400 hover:text-red-400 p-2 transition-colors"><IconTrash /></button>
                                </div>
                            </div>
                        ))}
                    </div>

                    <button 
                        onClick={() => setIsAdding(true)}
                        className="absolute bottom-6 right-6 w-14 h-14 bg-blue-600 hover:bg-blue-500 rounded-full flex items-center justify-center shadow-lg text-white transition-transform active:scale-90 z-10"
                    >
                        <IconPlus />
                    </button>

                    {isAdding && (
                        <div className="fixed inset-0 bg-slate-950/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in" onClick={() => setIsAdding(false)}>
                            <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl animate-scale-in text-center" onClick={e => e.stopPropagation()}>
                                <h3 className="text-2xl font-bold mb-6 text-white">Ny uppgift</h3>
                                <input className="input-field text-center !py-3 !mb-3" placeholder="Aktivitet" autoFocus value={newTodo.desc} onChange={e => setNewTodo({...newTodo, desc: e.target.value})} />
                                <input type="number" className="input-field text-center !py-3 !mb-3" placeholder="Tid (min)?" value={newTodo.minutes} onChange={e => setNewTodo({...newTodo, minutes: e.target.value})} />
                                <div className="flex gap-2 justify-center mb-4 mt-2">
                                    {['high', 'medium', 'low'].map(p => (
                                        <button key={p} onClick={() => setNewTodo({...newTodo, priority: p})} className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${newTodo.priority === p ? (p === 'high' ? 'bg-red-600 text-white shadow' : p === 'medium' ? 'bg-yellow-600 text-white shadow' : 'bg-green-600 text-white shadow') : 'bg-slate-800 text-slate-400'}`}>{pLabels[p]}</button>
                                    ))}
                                </div>
                                <div className="flex gap-2 mt-4">
                                    <button onClick={() => setIsAdding(false)} className="btn-secondary">Avbryt</button>
                                    <button disabled={!newTodo.desc || !newTodo.minutes} className={`w-full font-bold text-lg py-3 rounded-xl transition-colors ${(!newTodo.desc || !newTodo.minutes) ? 'bg-slate-800 text-slate-600 cursor-not-allowed' : 'bg-gradient-to-r from-orange-500 to-orange-600 text-white'}`} onClick={addTodo}>Skapa</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {editingTodo && (
                        <div className="fixed inset-0 bg-slate-950/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in" onClick={() => setEditingTodo(null)}>
                            <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl animate-scale-in text-center" onClick={e => e.stopPropagation()}>
                                <h3 className="text-2xl font-bold mb-6 text-white">Redigera uppgift</h3>
                                <input className="input-field text-center !py-3 !mb-3" placeholder="Aktivitet" autoFocus value={editingTodo.desc} onChange={e => setEditingTodo({...editingTodo, desc: e.target.value})} />
                                <input type="number" className="input-field text-center !py-3 !mb-3" placeholder="Tid (min)?" value={editingTodo.minutes} onChange={e => setEditingTodo({...editingTodo, minutes: e.target.value})} />
                                <div className="flex gap-2 justify-center mb-4 mt-2">
                                    {['high', 'medium', 'low'].map(p => (
                                        <button key={p} onClick={() => setEditingTodo({...editingTodo, priority: p})} className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${editingTodo.priority === p ? (p === 'high' ? 'bg-red-600 text-white shadow' : p === 'medium' ? 'bg-yellow-600 text-white shadow' : 'bg-green-600 text-white shadow') : 'bg-slate-800 text-slate-400'}`}>{pLabels[p]}</button>
                                    ))}
                                </div>
                                <div className="flex gap-2 mt-4">
                                    <button onClick={() => setEditingTodo(null)} className="btn-secondary">Avbryt</button>
                                    <button disabled={!editingTodo.desc || !editingTodo.minutes} className={`w-full font-bold text-lg py-3 rounded-xl transition-colors ${(!editingTodo.desc || !editingTodo.minutes) ? 'bg-slate-800 text-slate-600 cursor-not-allowed' : 'bg-gradient-to-r from-orange-500 to-orange-600 text-white'}`} onClick={saveTodoEdit}>Spara</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 5. Habit Tracker
        const HabitTracker = () => {
            const [habits, setHabits] = useState([]);
            const [newHabit, setNewHabit] = useState('');
            const [isAdding, setIsAdding] = useState(false);
            const [editingHabit, setEditingHabit] = useState(null);
            const longPressTimer = useRef(null);
            const isLongPress = useRef(false);
            const [view, setView] = useState('list');
            const [calendarDate, setCalendarDate] = useState(new Date());

            const getTodayString = () => new Date().toISOString().split('T')[0];

            // Load and reset logic
            useEffect(() => {
                const savedData = localStorage.getItem('habitsData');
                let data = { habits: [], lastReset: getTodayString() };

                if (savedData) {
                    data = JSON.parse(savedData);
                }

                const today = getTodayString();
                if (data.lastReset !== today) {
                    data.habits = data.habits.map(h => ({ ...h, completed: false }));
                    data.lastReset = today;
                    localStorage.setItem('habitsData', JSON.stringify(data));
                }
                
                setHabits(data.habits);
            }, []);

            const saveData = (updatedHabits) => {
                const today = getTodayString();
                localStorage.setItem('habitsData', JSON.stringify({ habits: updatedHabits, lastReset: today }));
                setHabits(updatedHabits);
            };

            const addHabit = () => {
                if (!newHabit.trim()) return;
                const updatedHabits = [...habits, { id: Date.now(), name: newHabit, completed: false }];
                saveData(updatedHabits);
                setNewHabit('');
                setIsAdding(false);
            };

            const handleLongPressStart = (habit) => {
                isLongPress.current = false;
                longPressTimer.current = setTimeout(() => {
                    isLongPress.current = true;
                    setEditingHabit(habit);
                }, 500);
            };

            const handleLongPressEnd = () => {
                if (longPressTimer.current) clearTimeout(longPressTimer.current);
            };

            const handleHabitClick = (habitId) => {
                if (isLongPress.current) return;
                toggleHabit(habitId);
            };

            const saveHabitEdit = () => {
                if (!editingHabit.name) return;
                const updatedHabits = habits.map(h => h.id === editingHabit.id ? editingHabit : h);
                saveData(updatedHabits);
                setEditingHabit(null);
            };

            const deleteHabit = () => {
                if(confirm("Vill du ta bort denna vana?")) {
                    const updatedHabits = habits.filter(h => h.id !== editingHabit.id);
                    saveData(updatedHabits);
                    setEditingHabit(null);
                }
            };

            const toggleHabit = (id) => {
                const updatedHabits = habits.map(h =>
                    h.id === id ? { ...h, completed: !h.completed } : h
                );
                saveData(updatedHabits);

                // Log history
                const logs = JSON.parse(localStorage.getItem('logs') || '[]');
                const today = getTodayString();
                const habit = habits.find(h => h.id === id);
                if (!habit.completed) { // Was not completed, now is
                    logs.push({ type: 'habit_done', habitId: id, name: habit.name, timestamp: new Date().toISOString(), dateStr: today });
                } else {
                    const idx = logs.findIndex(l => l.type === 'habit_done' && l.habitId === id && l.dateStr === today);
                    if (idx > -1) logs.splice(idx, 1);
                }
                localStorage.setItem('logs', JSON.stringify(logs));
            };

            const sortedHabits = [...habits].sort((a, b) => a.completed - b.completed);

            return (
                <div className="p-4 h-full flex flex-col relative">
                    <div className="mb-6 flex justify-between items-start">
                        <h2 className="text-3xl font-bold text-white">Vanor</h2>
                        <button onClick={() => setView(view === 'list' ? 'calendar' : 'list')} className="p-2 bg-slate-900 border border-slate-800 rounded-xl text-slate-400 hover:text-white transition-colors">
                            {view === 'list' ? <IconCalendar /> : <IconList />}
                        </button>
                    </div>

                    {view === 'list' ? (
                    <div className="flex-1 overflow-y-auto space-y-3 pb-20">
                        {habits.length === 0 && <p className="text-center text-slate-500 mt-10 text-sm">Lägg till din första vana.</p>}
                        {sortedHabits.map(habit => (
                            <div 
                                key={habit.id} 
                                onClick={() => handleHabitClick(habit.id)} 
                                onMouseDown={() => handleLongPressStart(habit)}
                                onMouseUp={handleLongPressEnd}
                                onMouseLeave={handleLongPressEnd}
                                onTouchStart={() => handleLongPressStart(habit)}
                                onTouchEnd={handleLongPressEnd}
                                onTouchMove={handleLongPressEnd}
                                className={`p-4 rounded-2xl flex justify-between items-center cursor-pointer transition-all border select-none active:scale-[0.99] ${habit.completed ? 'bg-green-900/20 border-green-500/30' : 'bg-slate-900/50 border-slate-800 hover:border-slate-700'}`}>
                                <span className={`text-lg font-medium ${habit.completed ? 'line-through text-slate-500' : 'text-white'}`}>{habit.name}</span>
                                <div className={`w-6 h-6 rounded-full flex items-center justify-center border-2 transition-colors ${habit.completed ? 'bg-green-500 border-green-500 text-white' : 'border-slate-600 text-transparent'}`}>
                                    {habit.completed && <IconCheck />}
                                </div>
                            </div>
                        ))}
                    </div>
                    ) : (
                        <div className="flex-1 overflow-y-auto pb-20">
                            <div className="flex justify-between items-center mb-6 px-2">
                                <button onClick={() => setCalendarDate(new Date(calendarDate.getFullYear(), calendarDate.getMonth() - 1, 1))} className="p-2 hover:text-white text-slate-400"><IconChevronLeft /></button>
                                <span className="font-bold capitalize text-white text-lg">{calendarDate.toLocaleDateString('sv-SE', { month: 'long', year: 'numeric' })}</span>
                                <button onClick={() => setCalendarDate(new Date(calendarDate.getFullYear(), calendarDate.getMonth() + 1, 1))} className="p-2 hover:text-white text-slate-400"><IconChevronRight /></button>
                            </div>
                            <div className="grid grid-cols-7 gap-2 text-center mb-3">
                                {['M', 'T', 'O', 'T', 'F', 'L', 'S'].map(d => <span key={d} className="text-xs text-slate-500 font-bold">{d}</span>)}
                            </div>
                            <div className="grid grid-cols-7 gap-2">
                                {(() => {
                                    const year = calendarDate.getFullYear();
                                    const month = calendarDate.getMonth();
                                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                                    const firstDay = (new Date(year, month, 1).getDay() + 6) % 7;
                                    const logs = JSON.parse(localStorage.getItem('logs') || '[]');
                                    
                                    const cells = [];
                                    for (let i = 0; i < firstDay; i++) cells.push(<div key={`empty-${i}`}></div>);
                                    for (let i = 1; i <= daysInMonth; i++) {
                                        const dateStr = new Date(Date.UTC(year, month, i)).toISOString().split('T')[0];
                                        const doneCount = logs.filter(l => l.type === 'habit_done' && l.dateStr === dateStr).length;
                                        const isToday = dateStr === getTodayString();
                                        
                                        let bgClass = 'bg-slate-900/50 border-slate-800 text-slate-500';
                                        if (doneCount > 0) bgClass = 'bg-green-900/30 border-green-500/30 text-green-400';
                                        if (doneCount >= 3) bgClass = 'bg-green-600 border-green-500 text-white shadow-lg shadow-green-900/50';

                                        cells.push(
                                            <div key={i} className={`aspect-square rounded-xl border flex items-center justify-center text-sm font-bold relative transition-all ${bgClass} ${isToday ? 'ring-2 ring-blue-500 z-10' : ''}`}>
                                                {i}
                                            </div>
                                        );
                                    }
                                    return cells;
                                })()}
                            </div>
                        </div>
                    )}
                    
                    <button 
                        onClick={() => setIsAdding(true)}
                        className="absolute bottom-6 right-6 w-14 h-14 bg-blue-600 hover:bg-blue-500 rounded-full flex items-center justify-center shadow-lg text-white transition-transform active:scale-90 z-10"
                    >
                        <IconPlus />
                    </button>

                    {isAdding && (
                        <div className="fixed inset-0 bg-slate-950/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in" onClick={() => setIsAdding(false)}>
                            <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl animate-scale-in text-center" onClick={e => e.stopPropagation()}>
                                <h3 className="text-2xl font-bold mb-6 text-white">Ny vana</h3>
                                <input 
                                    className="input-field text-center !py-3 !mb-3" 
                                    placeholder="Vad vill du göra?" 
                                    autoFocus
                                    value={newHabit} 
                                    onChange={e => setNewHabit(e.target.value)}
                                    onKeyPress={e => e.key === 'Enter' && addHabit()}
                                />
                                <div className="flex gap-2 mt-4">
                                    <button onClick={() => setIsAdding(false)} className="btn-secondary">Avbryt</button>
                                    <button onClick={addHabit} className="w-full font-bold text-lg py-3 rounded-xl transition-colors bg-gradient-to-r from-orange-500 to-orange-600 text-white">Spara</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {editingHabit && (
                        <div className="fixed inset-0 bg-slate-950/70 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in" onClick={() => setEditingHabit(null)}>
                            <div className="bg-slate-900 border border-slate-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl animate-scale-in text-center" onClick={e => e.stopPropagation()}>
                                <h3 className="text-2xl font-bold mb-6 text-white">Redigera vana</h3>
                                <input 
                                    className="input-field text-center !py-3 !mb-3" 
                                    placeholder="Vad vill du göra?" 
                                    autoFocus
                                    value={editingHabit.name} 
                                    onChange={e => setEditingHabit({...editingHabit, name: e.target.value})}
                                />
                                <div className="flex gap-2 mt-4">
                                    <button onClick={() => setEditingHabit(null)} className="btn-secondary">Avbryt</button>
                                    <button onClick={deleteHabit} className="bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-4 rounded-xl transition-colors active:scale-95 flex-1">Ta bort</button>
                                    <button onClick={saveHabitEdit} className="btn-primary bg-gradient-to-r from-orange-500 to-orange-600">Spara</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const saveToLog = (entry) => {
            const existing = JSON.parse(localStorage.getItem('logs') || '[]');
            existing.push(entry);
            localStorage.setItem('logs', JSON.stringify(existing));
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [timerData, setTimerData] = useState({ goal: '', challenges: '', motivation: 50, durationMinutes: 25 });

            const startTodo = (todo) => {
                setTimerData(prev => ({ ...prev, goal: todo.desc, durationMinutes: todo.minutes }));
                setActiveTab('timer');
            };

            return (
                <div className="flex flex-col h-screen max-w-md mx-auto bg-slate-950 shadow-2xl border-x border-slate-900">
                    <div className="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-900">
                        <h1 className="font-bold text-lg tracking-tight text-blue-400">MIND<span className="text-white">CTRL</span></h1>
                        <div className="text-xs text-slate-500 font-mono">v1.2</div>
                    </div>
                    <div className="flex-1 overflow-hidden relative">
                        <div className={activeTab === 'timer' ? 'h-full' : 'hidden'}>
                            <ActivityTimer data={timerData} setData={setTimerData} />
                        </div>
                        {activeTab === 'impulse' && <ImpulseControl />}
                        {activeTab === 'todo' && <TodoList onStartTodo={startTodo} />}
                        {activeTab === 'habits' && <HabitTracker />}
                        {activeTab === 'home' && <Dashboard />}
                    </div>
                    <div className="h-16 bg-slate-900 border-t border-slate-800 flex justify-around items-center">
                        <NavButton active={activeTab === 'timer'} onClick={() => setActiveTab('timer')} icon={<IconTimer />} label="Fokus" />
                        <NavButton active={activeTab === 'todo'} onClick={() => setActiveTab('todo')} icon={<IconCheck />} label="To-do" />
                        <NavButton active={activeTab === 'home'} onClick={() => setActiveTab('home')} icon={<IconHome />} label="Start" />
                        <NavButton active={activeTab === 'impulse'} onClick={() => setActiveTab('impulse')} icon={<IconZap />} label="Impuls" />
                        <NavButton active={activeTab === 'habits'} onClick={() => setActiveTab('habits')} icon={<IconGrid />} label="Vanor" />
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>